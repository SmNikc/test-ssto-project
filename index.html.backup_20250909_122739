<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–¥—É–ª—å –¢–ï–°–¢ –°–°–¢–û - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º</title>
    
    <!-- OpenLayers –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    
    <!-- XLSX –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- jsPDF –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .logo-text h1 {
            font-size: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2px;
        }
        
        .logo-text p {
            font-size: 12px;
            color: #666;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .navigation {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin: 20px auto;
            max-width: 1400px;
            border-radius: 10px;
            padding: 10px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: 0.3s;
        }
        
        .tab:hover {
            background: #f7fafc;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .content-area {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            animation: fadeIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card .change {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* –§–æ—Ä–º—ã */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group.highlight {
            background: #fff3cd;
            border: 3px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .form-group.highlight label {
            color: #d32f2f;
            font-size: 18px;
            font-weight: bold;
        }
        
        .form-group.highlight input {
            font-size: 20px;
            font-weight: bold;
            border: 3px solid #ff6b6b;
        }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-confirmed {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-active {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* –ö–∞—Ä—Ç–∞ */
        #map {
            height: 500px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .map-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .modal-close {
            font-size: 30px;
            color: #a0aec0;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .modal-close:hover {
            color: #4a5568;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .notification.success {
            background: #48bb78;
        }
        
        .notification.error {
            background: #f56565;
        }
        
        .notification.info {
            background: #4299e1;
        }
        
        /* –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ */
        #excel-upload {
            display: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üö¢</div>
                <div class="logo-text">
                    <h1>–ú–û–î–£–õ–¨ –¢–ï–°–¢ –°–°–¢–û</h1>
                    <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –°–°–¢–û</p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="window.excelLoader.openFileDialog()">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel</button>
                <button class="btn btn-secondary" onclick="window.emailSender.configureSMTP()">‚úâÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Email</button>
                <button class="btn btn-secondary" onclick="exportSettings()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
                <button class="btn btn-secondary" onclick="importSettings()">üì• –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫</button>
            </div>
        </div>
    </div>
    
    <div class="navigation">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="tab" onclick="switchTab('new-request')">‚ûï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
            <button class="tab" onclick="switchTab('requests')">üìã –ó–∞—è–≤–∫–∏</button>
            <button class="tab" onclick="switchTab('signals')">üì° –°–∏–≥–Ω–∞–ª—ã</button>
            <button class="tab" onclick="switchTab('terminals')">üñ•Ô∏è –¢–µ—Ä–º–∏–Ω–∞–ª—ã</button>
            <button class="tab" onclick="switchTab('map-container')">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
            <button class="tab" onclick="switchTab('reports')">üìà –û—Ç—á—ë—Ç—ã</button>
        </div>
    </div>
    
    <div class="content-area">
        <!-- –ì–ª–∞–≤–Ω–∞—è -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–ê–ö–¢–ò–í–ù–´–ï –ó–ê–Ø–í–ö–ò</h3>
                    <div class="value" id="total-requests">0</div>
                    <div class="change">‚Üë +2 –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <h3>–û–ñ–ò–î–ê–Æ–¢ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø</h3>
                    <div class="value" id="pending-requests">0</div>
                    <div class="change">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                </div>
                <div class="stat-card">
                    <h3>–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û</h3>
                    <div class="value" id="confirmed-requests">0</div>
                    <div class="change">‚Üë +5 –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                </div>
                <div class="stat-card">
                    <h3>–í–°–ï–ì–û –°–ò–ì–ù–ê–õ–û–í</h3>
                    <div class="value" id="total-signals">0</div>
                    <div class="change">–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
                </div>
            </div>
            
            <div style="background: #e6fffa; border: 2px solid #38b2ac; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: #234e52; margin-bottom: 10px;">–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</h3>
                <p>–†–µ–∂–∏–º: <strong id="auto-confirm-status">–û–¢–ö–õ–Æ–ß–ï–ù</strong></p>
                <button class="btn btn-primary" onclick="toggleAutoConfirm()">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º</button>
            </div>
            
            <div class="map-controls">
                <button class="btn btn-primary" onclick="processEmailQueue()">üìß –û–±—Ä–∞–±–æ—Ç–∞—Ç—å email –æ—á–µ—Ä–µ–¥—å</button>
                <button class="btn btn-primary" onclick="syncWithPoiskMore()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ü–æ–∏—Å–∫-–ú–æ—Ä–µ</button>
                <button class="btn btn-secondary" onclick="generateTestData()">üé≤ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
                <button class="btn btn-secondary" onclick="systemHealthCheck()">üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã</button>
            </div>
        </div>
        
        <!-- –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ -->
        <div id="new-request" class="tab-content">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –°–°–¢–û</h2>
            <form id="request-form">
                <div class="form-group highlight">
                    <label>‚ö†Ô∏è –ù–û–ú–ï–† –°–¢–û–ô–ö–ò –°–°–¢–û (–ì–õ–ê–í–ù–´–ô –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¢–û–†) *</label>
                    <input type="text" id="station-number" name="station-number" required pattern="[0-9]{9}" 
                           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 427309676" maxlength="9">
                    <small style="color: #d32f2f;">–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è</small>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="form-group">
                        <label>–¢–∏–ø —Å–ø—É—Ç–Ω–∏–∫–æ–≤–æ–π —Å–≤—è–∑–∏ *</label>
                        <div>
                            <label><input type="radio" name="satcom-type" value="INMARSAT" checked> –ò–ù–ú–ê–†–°–ê–¢</label>
                            <label><input type="radio" name="satcom-type" value="IRIDIUM"> –ò–†–ò–î–ò–£–ú</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–¥–Ω–∞ *</label>
                        <input type="text" id="vessel-name" name="vessel-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>MMSI *</label>
                        <input type="text" id="mmsi" name="mmsi" required pattern="[0-9]{9}" maxlength="9">
                    </div>
                    
                    <div class="form-group">
                        <label>IMO</label>
                        <input type="text" id="imo" name="imo" pattern="[0-9]{7}" maxlength="7">
                    </div>
                    
                    <div class="form-group">
                        <label>–°—É–¥–æ–≤–ª–∞–¥–µ–ª–µ—Ü *</label>
                        <input type="text" id="ship-owner" name="ship-owner" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞ *</label>
                        <input type="date" id="test-date" name="test-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label>–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞</label>
                        <input type="time" id="test-time" name="test-time">
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="margin-top: 20px;">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
            </form>
        </div>
        
        <!-- –ó–∞—è–≤–∫–∏ -->
        <div id="requests" class="tab-content">
            <h2>–°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="requests-tbody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </tbody>
            </table>
        </div>
        
        <!-- –°–∏–≥–Ω–∞–ª—ã -->
        <div id="signals" class="tab-content">
            <h2>–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –°–°–¢–û</h2>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>–¢–∏–ø</th>
                        <th>–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è</th>
                        <th>–¢–µ—Å—Ç/–¢—Ä–µ–≤–æ–≥–∞</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="signals-tbody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </tbody>
            </table>
        </div>
        
        <!-- –¢–µ—Ä–º–∏–Ω–∞–ª—ã -->
        <div id="terminals" class="tab-content">
            <h2>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –°–°–¢–û</h2>
            <div class="map-controls">
                <button class="btn btn-primary" onclick="addNewTerminal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª</button>
                <button class="btn btn-secondary" onclick="app.vesselDB.exportToCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>–¢–∏–ø —Å–≤—è–∑–∏</th>
                        <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç</th>
                        <th>–°–ª–µ–¥—É—é—â–∏–π —Ç–µ—Å—Ç</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="terminals-tbody">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </tbody>
            </table>
        </div>
        
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div id="map-container" class="tab-content">
            <h2>–ö–∞—Ä—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –°–°–¢–û</h2>
            <div id="map"></div>
            <div class="map-controls">
                <button class="btn btn-primary" onclick="window.mapManager.zoomToSignals()">üéØ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                <button class="btn btn-primary" onclick="window.mapManager.measureDistance()">üìè –ò–∑–º–µ—Ä–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="window.mapManager.exportMapImage()">üì∑ –°–∫—Ä–∏–Ω—à–æ—Ç</button>
                <button class="btn btn-secondary" onclick="window.mapManager.clearMap()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        
        <!-- –û—Ç—á—ë—Ç—ã -->
        <div id="reports" class="tab-content">
            <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤</h2>
            <div class="form-group">
                <label>–¢–∏–ø –æ—Ç—á—ë—Ç–∞</label>
                <select id="report-type">
                    <option value="daily">–°—É—Ç–æ—á–Ω—ã–π</option>
                    <option value="weekly">–ù–µ–¥–µ–ª—å–Ω—ã–π</option>
                    <option value="monthly">–ú–µ—Å—è—á–Ω—ã–π</option>
                    <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</option>
                </select>
            </div>
            <div class="map-controls">
                <button class="btn btn-primary" onclick="generateDailyReport()">üìä –°—É—Ç–æ—á–Ω—ã–π –æ—Ç—á—ë—Ç</button>
                <button class="btn btn-primary" onclick="generateWeeklyReport()">üìä –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç</button>
                <button class="btn btn-primary" onclick="generateMonthlyReport()">üìä –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç</button>
                <button class="btn btn-secondary" onclick="exportReportToPDF()">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
            </div>
            <div id="report-content" style="margin-top: 20px;">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç—á—ë—Ç–∞ -->
            </div>
        </div>
    </div>
    
    <!-- –°–∫—Ä—ã—Ç—ã–π input –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ Excel -->
    <input type="file" id="excel-upload" accept=".xlsx,.xls,.csv">
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    
    <script>
        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
        const app = {
            autoConfirmManager: null,
            emailProcessor: null,
            poiskMoreIntegration: null,
            vesselDB: null,
            map: null,
            markers: [],
            currentTab: 'dashboard',
            filters: {
                dateFrom: null,
                dateTo: null,
                status: 'all',
                vesselMMSI: null,
                signalType: 'all'
            }
        };

        // ===== –ö–õ–ê–°–° VesselDB - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å—É–¥–æ–≤ =====
        class VesselDB {
            constructor() {
                this.vessels = JSON.parse(localStorage.getItem('vessels') || '[]');
                this.initDefaultVessels();
            }

            initDefaultVessels() {
                if (this.vessels.length === 0) {
                    this.vessels = [
                        {
                            id: 'V001',
                            name: '–ê–ö–ê–î–ï–ú–ò–ö –õ–û–ú–û–ù–û–°–û–í',
                            mmsi: '273456789',
                            imo: '9876543',
                            callSign: 'UBXR',
                            flag: 'RU',
                            type: 'Research Vessel',
                            stationNumbers: ['427309676', '427309677'],
                            owner: '–†–æ—Å—Å–∏–π—Å–∫–∞—è –ê–∫–∞–¥–µ–º–∏—è –ù–∞—É–∫',
                            operator: '–†–ê–ù –§–ª–æ—Ç',
                            email: 'fleet@ras.ru',
                            satcomType: 'INMARSAT',
                            lastTest: '2025-01-15T10:00:00Z',
                            nextTest: '2025-02-15T10:00:00Z',
                            status: 'ACTIVE'
                        },
                        {
                            id: 'V002',
                            name: '–ö–ê–ü–ò–¢–ê–ù –í–û–†–û–ù–ò–ù',
                            mmsi: '273456790',
                            imo: '9876544',
                            callSign: 'UBXS',
                            flag: 'RU',
                            type: 'Cargo',
                            stationNumbers: ['427309678'],
                            owner: '–°–µ–≤–µ—Ä–Ω–æ–µ –ú–æ—Ä—Å–∫–æ–µ –ü–∞—Ä–æ—Ö–æ–¥—Å—Ç–≤–æ',
                            operator: '–°–ú–ü',
                            email: 'dispatch@smp.ru',
                            satcomType: 'IRIDIUM',
                            lastTest: '2025-01-20T14:00:00Z',
                            nextTest: '2025-02-20T14:00:00Z',
                            status: 'ACTIVE'
                        }
                    ];
                    this.save();
                }
            }

            save() {
                localStorage.setItem('vessels', JSON.stringify(this.vessels));
            }

            findByStationNumber(stationNumber) {
                return this.vessels.find(v => 
                    v.stationNumbers && v.stationNumbers.includes(stationNumber)
                );
            }

            findByMMSI(mmsi) {
                return this.vessels.find(v => v.mmsi === mmsi);
            }

            addVessel(vessel) {
                vessel.id = `V${Date.now()}`;
                vessel.createdAt = new Date().toISOString();
                vessel.status = vessel.status || 'ACTIVE';
                this.vessels.push(vessel);
                this.save();
                return vessel;
            }

            exportToCSV() {
                const headers = ['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', 'MMSI', 'IMO', '–ü–æ–∑—ã–≤–Ω–æ–π', '–ù–æ–º–µ—Ä–∞ —Å—Ç–æ–µ–∫', '–í–ª–∞–¥–µ–ª–µ—Ü', 'Email', '–¢–∏–ø —Å–≤—è–∑–∏', '–°—Ç–∞—Ç—É—Å'];
                const rows = this.vessels.map(v => [
                    v.id,
                    v.name,
                    v.mmsi,
                    v.imo || '',
                    v.callSign || '',
                    (v.stationNumbers || []).join(';'),
                    v.owner || '',
                    v.email || '',
                    v.satcomType || '',
                    v.status
                ]);

                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `vessels_${Date.now()}.csv`;
                link.click();
                URL.revokeObjectURL(url);
            }

            getActiveVessels() {
                return this.vessels.filter(v => v.status === 'ACTIVE');
            }
        }

        // ===== –ö–õ–ê–°–° AutoConfirmationManager =====
        class AutoConfirmationManager {
            constructor() {
                this.enabled = localStorage.getItem('autoConfirmEnabled') === 'true';
                this.adminPassword = 'Admin@SSTO2025';
            }

            toggleAutoConfirmation(password, reason, userId) {
                if (password !== this.adminPassword) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                }

                this.enabled = !this.enabled;
                localStorage.setItem('autoConfirmEnabled', this.enabled.toString());

                return {
                    success: true,
                    enabled: this.enabled,
                    message: `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ${this.enabled ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–æ—Ç–∫–ª—é—á–µ–Ω–æ'}`
                };
            }

            processSignal(signal) {
                if (!this.enabled) {
                    return { processed: false, reason: '–ê–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ' };
                }

                const requests = JSON.parse(localStorage.getItem('testRequests') || '[]');
                const matchingRequest = requests.find(req => 
                    req.stationNumber === signal.stationNumber &&
                    req.status === 'pending'
                );

                if (!matchingRequest) {
                    return { processed: false, reason: '–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∞—è –∑–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞' };
                }

                matchingRequest.status = 'confirmed';
                matchingRequest.confirmedAt = new Date().toISOString();
                
                localStorage.setItem('testRequests', JSON.stringify(requests));

                return {
                    processed: true,
                    requestId: matchingRequest.id
                };
            }
        }

// ===== –û–ë–ù–û–í–õ–ï–ù–ù–´–ô EmailProcessor —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ =====
class EmailProcessor {
    constructor() {
        this.emailQueue = JSON.parse(localStorage.getItem('emailQueue') || '[]');
        this.processedEmails = JSON.parse(localStorage.getItem('processedEmails') || '[]');
        this.emailPatterns = {
            // –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            testSignal: /---TEST SSAS TEST---|TEST SSAS/i,
            mobileTerminal: /Mobile Terminal No[:\s]*(\d{9})/i,
            stationNumber: /Station Number[:\s]*(\d{9})|Mobile Terminal No[:\s]*(\d{9})/i,
            position: /Position[:\s]*([\d.]+)[NS]\s*([\d.]+)[EW]/i,
            coordinates: /(\d+\.?\d*)[NS]\s+(\d+\.?\d*)[EW]/i,
            utcTime: /(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})/i,
            mmsi: /MMSI[:\s]*(\d{9})|(\d{9})\s+\d{4}-\d{2}-\d{2}/i,
            vesselName: /Vessel[:\s]*([A-Za-z–ê-–Ø–∞-—è\s\-]+)/i
        };
    }

    parseIncomingEmail(emailContent, emailFrom, emailSubject) {
        console.log('–ü–∞—Ä—Å–∏–Ω–≥ –≤—Ö–æ–¥—è—â–µ–≥–æ email:', emailSubject);
        
        const signal = {
            id: `SIG-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            receivedAt: new Date().toISOString(),
            emailFrom: emailFrom,
            emailSubject: emailSubject,
            rawContent: emailContent,
            isTest: false,
            type: 'UNKNOWN',
            stationNumber: null,
            mmsi: null,
            vesselName: null,
            coordinates: null,
            positionTime: null
        };

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞
        if (this.emailPatterns.testSignal.test(emailContent)) {
            signal.isTest = true;
            signal.type = 'TEST';
        }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Å—Ç–æ–π–∫–∏/—Ç–µ—Ä–º–∏–Ω–∞–ª–∞
        const stationMatch = emailContent.match(this.emailPatterns.stationNumber);
        if (stationMatch) {
            signal.stationNumber = stationMatch[1] || stationMatch[2];
            console.log('–ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏:', signal.stationNumber);
        }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ MMSI
        const mmsiMatch = emailContent.match(this.emailPatterns.mmsi);
        if (mmsiMatch) {
            signal.mmsi = mmsiMatch[1] || mmsiMatch[2];
        }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        const coordMatch = emailContent.match(this.emailPatterns.coordinates);
        if (coordMatch) {
            signal.coordinates = {
                lat: parseFloat(coordMatch[1]),
                lon: parseFloat(coordMatch[2])
            };
        }

        // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ UTC
        const timeMatch = emailContent.match(this.emailPatterns.utcTime);
        if (timeMatch) {
            signal.positionTime = `${timeMatch[1]}T${timeMatch[2]}Z`;
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Å—É–¥–Ω–æ –≤ –±–∞–∑–µ
        if (signal.stationNumber) {
            const vessel = app.vesselDB.findByStationNumber(signal.stationNumber);
            if (vessel) {
                signal.vesselName = vessel.name;
                signal.mmsi = signal.mmsi || vessel.mmsi;
                signal.type = vessel.satcomType;
            }
        }

        return signal;
    }

    processTestSignalEmail(emailContent) {
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∞ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        const testData = {
            stationNumber: null,
            position: null,
            time: null,
            mmsi: null
        };

        // –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ –æ–±—Ä–∞–∑—Ü—É:
        // Mobile Terminal No:427305964
        // Position:41 28.83N 31 47.83'E
        // Position updated:08:26 2025-03-18 UTC
        
        const lines = emailContent.split('\n');
        lines.forEach(line => {
            if (line.includes('Mobile Terminal No')) {
                const match = line.match(/(\d{9})/);
                if (match) testData.stationNumber = match[1];
            }
            if (line.includes('Position:')) {
                const match = line.match(/([\d.]+)\s*[NS]\s*([\d.]+)\s*[EW]/);
                if (match) {
                    testData.position = {
                        lat: parseFloat(match[1]),
                        lon: parseFloat(match[2])
                    };
                }
            }
            if (line.includes('Position updated') || line.includes('UTC')) {
                const match = line.match(/(\d{2}:\d{2})\s+(\d{4}-\d{2}-\d{2})/);
                if (match) {
                    testData.time = `${match[2]}T${match[1]}:00Z`;
                }
            }
            if (line.match(/^\d{9}\s+\d{4}-\d{2}-\d{2}/)) {
                const match = line.match(/^(\d{9})/);
                if (match) testData.mmsi = match[1];
            }
        });

        return testData;
    }

    async simulateIncomingEmail() {
        // –°–∏–º—É–ª—è—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è email –∫–∞–∫ –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        const testEmail = `---TEST SSAS TEST---
Mobile Terminal No:427305964
Position:41 28.83N 31 47.83'E
Position updated:08:26 2025-03-18 UTC
---TEST SSAS TEST---
009598830 2025-03-18 08:26:42
41.28N 31.47E
2025-03-18 08:26:42
Coverage message setup:
E-mail:od_gmrcc@morflot.ru
E-mail:uvdp@volgaflot.com
E-mail:sb-tech@volgaflot.com`;

        const signal = this.parseIncomingEmail(
            testEmail,
            'ssas@inmarsat.com',
            'TEST SSAS ALERT'
        );

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞
        const signals = JSON.parse(localStorage.getItem('signals') || '[]');
        signals.push(signal);
        localStorage.setItem('signals', JSON.stringify(signals));

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        if (app.autoConfirmManager && app.autoConfirmManager.enabled) {
            const result = app.autoConfirmManager.processSignal(signal);
            if (result.processed) {
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                await this.generateOfficialConfirmation(signal, result.requestId);
            }
        }

        showNotification(`üìß –ü–æ–ª—É—á–µ–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç —Å—Ç–æ–π–∫–∏ ${signal.stationNumber}`, 'info');
        loadSignals();
        
        return signal;
    }

    async generateOfficialConfirmation(signal, requestId) {
        const request = JSON.parse(localStorage.getItem('testRequests') || '[]')
            .find(r => r.id === requestId);
        
        if (!request) return;

        const vessel = app.vesselDB.findByStationNumber(signal.stationNumber);
        
        // –®–∞–±–ª–æ–Ω –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ì–ú–°–ö–¶
        const confirmationHTML = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: 'Times New Roman', serif; margin: 40px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h3 { margin: 5px 0; font-size: 14px; }
        .doc-number { margin: 20px 0; }
        .content { margin: 30px 0; line-height: 1.6; }
        .signature { margin-top: 50px; }
        .details { margin: 20px 0; background: #f0f0f0; padding: 15px; }
        .details-line { margin: 5px 0; font-family: monospace; }
    </style>
</head>
<body>
    <div class="header">
        <h3>–ú–ò–ù–¢–†–ê–ù–° –†–û–°–°–ò–ò</h3>
        <h3>–†–û–°–ú–û–†–†–ï–ß–§–õ–û–¢</h3>
        <h3>–§–ï–î–ï–†–ê–õ–¨–ù–û–ï –ì–û–°–£–î–ê–†–°–¢–í–ï–ù–ù–û–ï –ë–Æ–î–ñ–ï–¢–ù–û–ï –£–ß–†–ï–ñ–î–ï–ù–ò–ï</h3>
        <h3>¬´–ú–û–†–°–ö–ê–Ø –°–ü–ê–°–ê–¢–ï–õ–¨–ù–ê–Ø –°–õ–£–ñ–ë–ê¬ª</h3>
        <h3>(–§–ì–ë–£ ¬´–ú–û–†–°–ü–ê–°–°–õ–£–ñ–ë–ê¬ª)</h3>
        <p style="font-size: 12px;">
            —É–ª. –ü–µ—Ç—Ä–æ–≤–∫–∞ –¥. 3/6 —Å—Ç—Ä. 2, –≥. –ú–æ—Å–∫–≤–∞, 125993<br>
            —Ç–µ–ª.: (495) 626-18-08<br>
            info@morspas.ru, www.morspas.ru<br>
            –û–ö–ü–û 18685292, –û–ì–†–ù 1027739737321<br>
            –ò–ù–ù/–ö–ü–ü 7707274249/770701001
        </p>
        <h3>–ì–ª–∞–≤–Ω—ã–π –º–æ—Ä—Å–∫–æ–π —Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω–æ-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä (–ì–ú–°–ö–¶)</h3>
    </div>

    <div class="doc-number">
        <strong>‚Ññ –ú–°–°-${request.id.replace('REQ-', '')}</strong><br>
        –æ—Ç ${new Date().toLocaleDateString('ru-RU')}
    </div>

    <div class="content">
        <p><strong>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –°–°–¢–û:</strong></p>
        
        <div class="details">
            <div class="details-line">---TEST SSAS TEST---</div>
            <div class="details-line">Mobile Terminal No:${signal.stationNumber}</div>
            <div class="details-line">Position:${signal.coordinates ? 
                signal.coordinates.lat + 'N ' + signal.coordinates.lon + 'E' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
            <div class="details-line">Position updated:${formatDate(signal.positionTime || signal.receivedAt)}</div>
            <div class="details-line">---TEST SSAS TEST---</div>
            <div class="details-line">${signal.mmsi || '000000000'} ${new Date().toISOString().split('T')[0]}</div>
            <div class="details-line">Vessel: ${vessel ? vessel.name : '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'}</div>
        </div>

        <p>Coverage message setup:</p>
        <p>E-mail: od_gmrcc@morflot.ru<br>
           E-mail: ${request.email}<br>
           ${vessel && vessel.operator ? `E-mail: ${vessel.operator}@volgaflot.com` : ''}
        </p>
    </div>

    <div class="signature">
        <p>–ü–æ–¥–ø–∏—Å–∞–Ω–æ –ü–≠–ü</p>
        <p><strong>–°.–ê. –ú–æ—Ö–Ω–∞—á–µ–≤</strong></p>
        <p>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–µ–∂—É—Ä–Ω—ã–π –ì–ú–°–ö–¶</p>
        <p>${new Date().toLocaleDateString('ru-RU')}</p>
        <br>
        <p>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–µ–∂—É—Ä–Ω—ã–π –ì–ú–°–ö–¶<br>
        +7 (495) 626-10-52</p>
    </div>
</body>
</html>
        `;

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        const confirmation = {
            id: `CONF-${Date.now()}`,
            requestId: requestId,
            signalId: signal.id,
            html: confirmationHTML,
            createdAt: new Date().toISOString(),
            documentNumber: `–ú–°–°-${request.id.replace('REQ-', '')}`,
            signedBy: '–°.–ê. –ú–æ—Ö–Ω–∞—á–µ–≤'
        };

        const confirmations = JSON.parse(localStorage.getItem('confirmations') || '[]');
        confirmations.push(confirmation);
        localStorage.setItem('confirmations', JSON.stringify(confirmations));

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ email –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
        if (window.emailSender && window.emailSender.enabled) {
            await window.emailSender.sendOfficialConfirmation(confirmation, request, vessel);
        }

        return confirmation;
    }
}

// –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
function viewConfirmation(requestId) {
    const confirmations = JSON.parse(localStorage.getItem('confirmations') || '[]');
    const confirmation = confirmations.find(c => c.requestId === requestId);
    
    if (!confirmation) {
        showNotification('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
        return;
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
    const win = window.open('', '_blank');
    win.document.write(confirmation.html);
    win.document.close();
}

// –î–æ–±–∞–≤—å—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è email –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
function addEmailTestButton() {
    const dashboardActions = document.querySelector('#dashboard .map-controls');
    if (dashboardActions) {
        const button = document.createElement('button');
        button.className = 'btn btn-primary';
        button.innerHTML = 'üì® –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π —Å–∏–≥–Ω–∞–ª';
        button.onclick = () => app.emailProcessor.simulateIncomingEmail();
        dashboardActions.appendChild(button);
    }
}

// –í—ã–∑–æ–≤–∏—Ç–µ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
document.addEventListener('DOMContentLoaded', () => {
    addEmailTestButton();
});

        // ===== –ö–õ–ê–°–° PoiskMoreIntegration =====
        class PoiskMoreIntegration {
            constructor() {
                this.syncEnabled = localStorage.getItem('poiskMoreSyncEnabled') === 'true';
            }

            async sendToPoiskMore(signal) {
                // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                return {
                    success: true,
                    poiskMoreId: `PM-${Date.now()}`,
                    message: '–°–∏–≥–Ω–∞–ª –ø–µ—Ä–µ–¥–∞–Ω –≤ –ü–æ–∏—Å–∫-–ú–æ—Ä–µ'
                };
            }

            async syncBatch(signals) {
                const results = [];
                for (const signal of signals) {
                    const result = await this.sendToPoiskMore(signal);
                    results.push(result);
                }
                return results;
            }
        }

        // ===== –ö–õ–ê–°–° AdvancedMapManager =====
        class AdvancedMapManager {
            constructor() {
                this.map = null;
                this.vectorSource = null;
            }

            initAdvancedMap() {
                if (!document.getElementById('map')) return;

                this.map = new ol.Map({
                    target: 'map',
                    layers: [
                        new ol.layer.Tile({
                            source: new ol.source.OSM()
                        })
                    ],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([37.6173, 55.7558]),
                        zoom: 5
                    })
                });

                this.vectorSource = new ol.source.Vector();
                const vectorLayer = new ol.layer.Vector({
                    source: this.vectorSource
                });
                this.map.addLayer(vectorLayer);

                this.loadSignalsToMap();
            }

            loadSignalsToMap() {
                const signals = JSON.parse(localStorage.getItem('signals') || '[]');
                this.vectorSource.clear();
                
                signals.forEach(signal => {
                    if (signal.coordinates) {
                        const feature = new ol.Feature({
                            geometry: new ol.geom.Point(
                                ol.proj.fromLonLat([signal.coordinates.lon, signal.coordinates.lat])
                            )
                        });
                        
                        const iconStyle = new ol.style.Style({
                            image: new ol.style.Circle({
                                radius: 8,
                                fill: new ol.style.Fill({
                                    color: signal.isTest ? 'rgba(0, 255, 0, 0.6)' : 'rgba(255, 0, 0, 0.6)'
                                }),
                                stroke: new ol.style.Stroke({
                                    color: signal.isTest ? 'green' : 'red',
                                    width: 2
                                })
                            })
                        });
                        
                        feature.setStyle(iconStyle);
                        this.vectorSource.addFeature(feature);
                    }
                });
            }

            zoomToSignals() {
                if (!this.vectorSource) return;
                const extent = this.vectorSource.getExtent();
                if (!ol.extent.isEmpty(extent)) {
                    this.map.getView().fit(extent, {
                        padding: [50, 50, 50, 50],
                        duration: 1000
                    });
                }
            }

            measureDistance() {
                alert('–§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞');
            }

            exportMapImage() {
                alert('–≠–∫—Å–ø–æ—Ä—Ç –∫–∞—Ä—Ç—ã –≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
            }

            clearMap() {
                if (this.vectorSource) {
                    this.vectorSource.clear();
                }
            }
        }

        // ===== –ö–õ–ê–°–° EmailAutoSender =====
// ===== –ö–õ–ê–°–° EmailAutoSender –° –ü–û–õ–ù–û–ô –ù–ê–°–¢–†–û–ô–ö–û–ô =====
class EmailAutoSender {
    constructor() {
        this.enabled = localStorage.getItem('emailAutoSendEnabled') === 'true';
        this.smtp = {
            host: localStorage.getItem('smtpHost') || 'smtp.gmail.com',
            port: localStorage.getItem('smtpPort') || '587',
            user: localStorage.getItem('smtpUser') || '',
            pass: localStorage.getItem('smtpPass') || '',
            from: localStorage.getItem('smtpFrom') || 'ssto@morflot.ru',
            secure: localStorage.getItem('smtpSecure') === 'true'
        };
        this.templates = this.loadTemplates();
        this.queue = JSON.parse(localStorage.getItem('emailQueue') || '[]');
    }

    loadTemplates() {
        const saved = localStorage.getItem('emailTemplates');
        if (saved) return JSON.parse(saved);
        
        return {
            testConfirmation: {
                subject: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –°–°–¢–û - {{vesselName}}',
                body: `
–§–ì–ë–£ ¬´–ú–û–†–°–ü–ê–°–°–õ–£–ñ–ë–ê¬ª
–ì–ª–∞–≤–Ω—ã–π –º–æ—Ä—Å–∫–æ–π —Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω–æ-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä

–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞ –æ—Ç —Å–∏—Å—Ç–µ–º—ã –°–°–¢–û

–î–µ—Ç–∞–ª–∏ —Ç–µ—Å—Ç–∞:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
–°—É–¥–Ω–æ: {{vesselName}}
MMSI: {{mmsi}}
IMO: {{imo}}
–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏ –°–°–¢–û: {{stationNumber}}
–¢–∏–ø —Å–∏—Å—Ç–µ–º—ã: {{satcomType}}
–î–∞—Ç–∞/–≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞: {{testDate}}
–î–∞—Ç–∞/–≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–∞: {{receivedAt}}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚úÖ –¢–ï–°–¢ –£–°–ü–ï–®–ù–û –ü–†–û–ô–î–ï–ù

–°–∏–≥–Ω–∞–ª –ø–æ–ª—É—á–µ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏.

–° —É–≤–∞–∂–µ–Ω–∏–µ–º,
–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–µ–∂—É—Ä–Ω—ã–π –ì–ú–°–ö–¶
–¢–µ–ª: +7 (495) 626-10-52
Email: gmskc@morflot.ru

---
–≠—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –¢–ï–°–¢ –°–°–¢–û.
                `
            }
        };
    }

    configureSMTP() {
        // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ Email</div>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                </div>
                <div style="padding: 20px;">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="email-auto-send" ${this.enabled ? 'checked' : ''}>
                            –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ—Ç–ø—Ä–∞–≤–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π
                        </label>
                    </div>
                    
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ SMTP —Å–µ—Ä–≤–µ—Ä–∞</h3>
                    
                    <div class="form-group">
                        <label>SMTP —Å–µ—Ä–≤–µ—Ä</label>
                        <input type="text" id="smtp-host" value="${this.smtp.host}" placeholder="smtp.gmail.com">
                    </div>
                    
                    <div class="form-group">
                        <label>–ü–æ—Ä—Ç</label>
                        <input type="text" id="smtp-port" value="${this.smtp.port}" placeholder="587">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="smtp-secure" ${this.smtp.secure ? 'checked' : ''}>
                            –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSL/TLS
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email)</label>
                        <input type="email" id="smtp-user" value="${this.smtp.user}" placeholder="user@domain.ru">
                    </div>
                    
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" id="smtp-pass" value="${this.smtp.pass}" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    
                    <div class="form-group">
                        <label>Email –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</label>
                        <input type="email" id="smtp-from" value="${this.smtp.from}" placeholder="ssto@morflot.ru">
                    </div>
                    
                    <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h3>
                    
                    <div class="form-group">
                        <label>–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∏—Å—å–º–∞–º–∏ (—Å–µ–∫)</label>
                        <input type="number" id="email-delay" value="${localStorage.getItem('emailDelay') || '5'}" min="1" max="60">
                    </div>
                    
                    <div class="form-group">
                        <label>–ö–æ–ø–∏—è –Ω–∞ email –ì–ú–°–ö–¶</label>
                        <input type="email" id="email-cc" value="${localStorage.getItem('emailCC') || 'gmskc@morflot.ru'}">
                    </div>
                    
                    <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin: 20px 0;">
                        <strong>‚ö†Ô∏è –í–∞–∂–Ω–æ:</strong><br>
                        –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ email —Ç—Ä–µ–±—É–µ—Ç—Å—è backend —Å–µ—Ä–≤–µ—Ä.<br>
                        –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –ø–∏—Å—å–º–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å –±–µ–∑ –æ—Ç–ø—Ä–∞–≤–∫–∏.
                    </div>
                    
                    <div class="map-controls">
                        <button class="btn btn-primary" onclick="window.emailSender.saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                        <button class="btn btn-secondary" onclick="window.emailSender.testConnection()">üîß –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</button>
                        <button class="btn btn-secondary" onclick="window.emailSender.viewQueue()">üìß –û—á–µ—Ä–µ–¥—å (${this.queue.length})</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    saveSettings() {
        this.enabled = document.getElementById('email-auto-send').checked;
        this.smtp.host = document.getElementById('smtp-host').value;
        this.smtp.port = document.getElementById('smtp-port').value;
        this.smtp.secure = document.getElementById('smtp-secure').checked;
        this.smtp.user = document.getElementById('smtp-user').value;
        this.smtp.pass = document.getElementById('smtp-pass').value;
        this.smtp.from = document.getElementById('smtp-from').value;
        
        localStorage.setItem('emailAutoSendEnabled', this.enabled);
        localStorage.setItem('smtpHost', this.smtp.host);
        localStorage.setItem('smtpPort', this.smtp.port);
        localStorage.setItem('smtpSecure', this.smtp.secure);
        localStorage.setItem('smtpUser', this.smtp.user);
        localStorage.setItem('smtpPass', this.smtp.pass);
        localStorage.setItem('smtpFrom', this.smtp.from);
        localStorage.setItem('emailDelay', document.getElementById('email-delay').value);
        localStorage.setItem('emailCC', document.getElementById('email-cc').value);
        
        showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ email —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
        document.querySelector('.modal').remove();
    }

    testConnection() {
        if (!this.smtp.host || !this.smtp.user || !this.smtp.pass) {
            showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SMTP', 'error');
            return;
        }
        
        // –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ backend
        showNotification('–î–µ–º–æ-—Ä–µ–∂–∏–º: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ', 'info');
    }

    viewQueue() {
        const modal = document.createElement('div');
        modal.className = 'modal active';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">üìß –û—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏ Email</div>
                    <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                </div>
                <div style="padding: 20px;">
                    <table style="width: 100%;">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ö–æ–º—É</th>
                                <th>–¢–µ–º–∞</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.queue.map(email => `
                                <tr>
                                    <td>${new Date(email.createdAt).toLocaleString('ru-RU')}</td>
                                    <td>${email.to}</td>
                                    <td>${email.subject}</td>
                                    <td><span class="status-badge status-${email.status}">${email.status}</span></td>
                                    <td>
                                        <button onclick="window.emailSender.resendEmail('${email.id}')" class="btn btn-secondary">–ü–æ–≤—Ç–æ—Ä</button>
                                        <button onclick="window.emailSender.removeFromQueue('${email.id}')" class="btn btn-secondary">–£–¥–∞–ª–∏—Ç—å</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="5">–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞</td></tr>'}
                        </tbody>
                    </table>
                    <div class="map-controls" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="window.emailSender.processQueue()">‚ñ∂Ô∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—á–µ—Ä–µ–¥—å</button>
                        <button class="btn btn-secondary" onclick="window.emailSender.clearQueue()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async sendConfirmation(request, signal) {
        if (!this.enabled) {
            console.log('–ê–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞ email –æ—Ç–∫–ª—é—á–µ–Ω–∞');
            return { success: false, reason: '–ê–≤—Ç–æ–æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞' };
        }

        const vessel = app.vesselDB.findByStationNumber(signal.stationNumber);
        if (!vessel || !vessel.email) {
            return { success: false, reason: 'Email —Å—É–¥–æ–≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω' };
        }

        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —à–∞–±–ª–æ–Ω–∞
        const templateData = {
            vesselName: vessel.name,
            mmsi: vessel.mmsi,
            imo: vessel.imo || '–ù–µ —É–∫–∞–∑–∞–Ω',
            stationNumber: signal.stationNumber,
            satcomType: vessel.satcomType,
            testDate: formatDate(request.testDate),
            receivedAt: formatDate(signal.receivedAt)
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–±–ª–æ–Ω–∞
        let subject = this.templates.testConfirmation.subject;
        let body = this.templates.testConfirmation.body;
        
        for (const [key, value] of Object.entries(templateData)) {
            const regex = new RegExp(`{{${key}}}`, 'g');
            subject = subject.replace(regex, value);
            body = body.replace(regex, value);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∏—Å—å–º–∞
        const email = {
            id: `EMAIL-${Date.now()}`,
            to: vessel.email,
            cc: localStorage.getItem('emailCC') || 'gmskc@morflot.ru',
            subject: subject,
            body: body,
            attachments: [],
            createdAt: new Date().toISOString(),
            status: 'pending',
            requestId: request.id,
            signalId: signal.id
        };

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å
        this.queue.push(email);
        localStorage.setItem('emailQueue', JSON.stringify(this.queue));

        // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏
        await this.processQueue();

        return {
            success: true,
            emailId: email.id,
            message: `Email –¥–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ ${vessel.email}`
        };
    }

    async processQueue() {
        const pending = this.queue.filter(e => e.status === 'pending');
        const delay = parseInt(localStorage.getItem('emailDelay') || '5') * 1000;
        
        for (const email of pending) {
            // –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            email.status = 'sent';
            email.sentAt = new Date().toISOString();
            
            showNotification(`üìß Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ ${email.to}`, 'success');
            
            // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∏—Å—å–º–∞–º–∏
            await new Promise(resolve => setTimeout(resolve, delay));
        }
        
        localStorage.setItem('emailQueue', JSON.stringify(this.queue));
        return { processed: pending.length };
    }

    resendEmail(emailId) {
        const email = this.queue.find(e => e.id === emailId);
        if (email) {
            email.status = 'pending';
            localStorage.setItem('emailQueue', JSON.stringify(this.queue));
            this.processQueue();
        }
    }

    removeFromQueue(emailId) {
        this.queue = this.queue.filter(e => e.id !== emailId);
        localStorage.setItem('emailQueue', JSON.stringify(this.queue));
        this.viewQueue(); // –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    }

    clearQueue() {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–∏—Å—å–º–∞ –∏–∑ –æ—á–µ—Ä–µ–¥–∏?')) {
            this.queue = [];
            localStorage.setItem('emailQueue', JSON.stringify(this.queue));
            document.querySelector('.modal').remove();
            showNotification('–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞', 'success');
        }
    }
}

        // ===== –ö–õ–ê–°–° ExcelDataLoader =====
        class ExcelDataLoader {
            constructor() {
                this.setupHandlers();
            }

            setupHandlers() {
                const input = document.getElementById('excel-upload');
                if (input) {
                    input.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            this.loadExcelFile(file);
                        }
                    });
                }
            }

            async loadExcelFile(file) {
                showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...', 'info');

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        
                        this.processImportedData(jsonData);
                        showNotification(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${jsonData.length} –∑–∞–ø–∏—Å–µ–π`, 'success');
                    } catch (error) {
                        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞', 'error');
                    }
                };
                reader.readAsBinaryString(file);
            }

            processImportedData(data) {
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                data.forEach(row => {
                    if (row['–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏'] && row['–°—É–¥–Ω–æ']) {
                        const vessel = {
                            name: row['–°—É–¥–Ω–æ'],
                            mmsi: String(row['MMSI'] || ''),
                            imo: String(row['IMO'] || ''),
                            stationNumbers: [String(row['–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏'])],
                            owner: row['–í–ª–∞–¥–µ–ª–µ—Ü'] || '',
                            email: row['Email'] || '',
                            satcomType: row['–¢–∏–ø —Å–≤—è–∑–∏'] || 'INMARSAT'
                        };
                        app.vesselDB.addVessel(vessel);
                    }
                });
                
                loadTerminals();
            }

            openFileDialog() {
                document.getElementById('excel-upload').click();
            }
        }

        // ===== –§–£–ù–ö–¶–ò–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø =====
        
        function initializeApp() {
            console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è –¢–ï–°–¢ –°–°–¢–û...');
            
            app.autoConfirmManager = new AutoConfirmationManager();
            app.emailProcessor = new EmailProcessor();
            app.poiskMoreIntegration = new PoiskMoreIntegration();
            app.vesselDB = new VesselDB();
            
            loadDashboardData();
            loadRequests();
            loadSignals();
            loadTerminals();
            
            updateAutoConfirmStatus();
            
            console.log('‚úÖ –ú–æ–¥—É–ª—å —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            event.target.classList.add('active');
            app.currentTab = tabName;
            
            if (tabName === 'map-container' && !app.map) {
                setTimeout(() => {
                    window.mapManager.initAdvancedMap();
                }, 100);
            }
        }

        function loadDashboardData() {
            const requests = JSON.parse(localStorage.getItem('testRequests') || '[]');
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            
            document.getElementById('total-requests').textContent = requests.length;
            document.getElementById('pending-requests').textContent = 
                requests.filter(r => r.status === 'pending').length;
            document.getElementById('confirmed-requests').textContent = 
                requests.filter(r => r.status === 'confirmed').length;
            document.getElementById('total-signals').textContent = signals.length;
        }

        function loadRequests() {
            const requests = JSON.parse(localStorage.getItem('testRequests') || '[]');
            const tbody = document.getElementById('requests-tbody');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            requests.forEach(request => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${request.id}</td>
                    <td><strong>${request.stationNumber}</strong></td>
                    <td>${request.vesselName}</td>
                    <td>${request.mmsi}</td>
                    <td>${formatDate(request.testDate)}</td>
                    <td><span class="status-badge status-${request.status}">${request.status}</span></td>
                    <td>
                        <button onclick="viewRequest('${request.id}')" class="btn btn-secondary">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                        ${request.status === 'pending' ? 
                            `<button onclick="confirmRequest('${request.id}')" class="btn btn-primary">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>` : 
                            `<button onclick="generateConfirmationPDF('${request.id}')" class="btn btn-primary">üìÑ PDF</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadSignals() {
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            const tbody = document.getElementById('signals-tbody');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            signals.forEach(signal => {
                const vessel = app.vesselDB.findByStationNumber(signal.stationNumber);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${signal.id}</td>
                    <td><strong>${signal.stationNumber}</strong></td>
                    <td>${vessel ? vessel.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                    <td>${signal.mmsi || '-'}</td>
                    <td>${signal.type}</td>
                    <td>${formatDate(signal.receivedAt)}</td>
                    <td>${signal.isTest ? '‚úÖ –¢–µ—Å—Ç' : 'üö® –¢—Ä–µ–≤–æ–≥–∞'}</td>
                    <td>
                        <button onclick="viewSignal('${signal.id}')" class="btn btn-secondary">–î–µ—Ç–∞–ª–∏</button>
                        ${!signal.isTest ? 
                            `<button onclick="sendToPoiskMore('${signal.id}')" class="btn btn-primary">–í –ü–æ–∏—Å–∫-–ú–æ—Ä–µ</button>` : 
                            ''
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function loadTerminals() {
            const vessels = app.vesselDB.getActiveVessels();
            const tbody = document.getElementById('terminals-tbody');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            vessels.forEach(vessel => {
                vessel.stationNumbers.forEach(stationNumber => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${stationNumber}</strong></td>
                        <td>${vessel.name}</td>
                        <td>${vessel.mmsi}</td>
                        <td>${vessel.satcomType}</td>
                        <td>${vessel.owner}</td>
                        <td>${formatDate(vessel.lastTest)}</td>
                        <td>${formatDate(vessel.nextTest)}</td>
                        <td><span class="status-badge status-active">–ê–∫—Ç–∏–≤–µ–Ω</span></td>
                        <td>
                            <button onclick="editTerminal('${stationNumber}')" class="btn btn-secondary">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                            <button onclick="testTerminal('${stationNumber}')" class="btn btn-primary">–¢–µ—Å—Ç</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function submitRequest() {
            const stationNumber = document.getElementById('station-number').value;
            const vesselName = document.getElementById('vessel-name').value;
            const mmsi = document.getElementById('mmsi').value;
            const imo = document.getElementById('imo').value;
            const shipOwner = document.getElementById('ship-owner').value;
            const email = document.getElementById('email').value;
            const testDate = document.getElementById('test-date').value;
            const testTime = document.getElementById('test-time').value;
            const satcomType = document.querySelector('input[name="satcom-type"]:checked')?.value;
            
            if (!stationNumber || !vesselName || !mmsi || !testDate || !satcomType) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            const request = {
                id: `REQ-${Date.now()}`,
                stationNumber: stationNumber,
                vesselName: vesselName,
                mmsi: mmsi,
                imo: imo,
                shipOwner: shipOwner,
                email: email,
                testDate: testDate,
                testTime: testTime,
                satcomType: satcomType,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            const requests = JSON.parse(localStorage.getItem('testRequests') || '[]');
            requests.push(request);
            localStorage.setItem('testRequests', JSON.stringify(requests));
            
            document.getElementById('request-form').reset();
            showNotification(`–ó–∞—è–≤–∫–∞ ${request.id} —Å–æ–∑–¥–∞–Ω–∞`, 'success');
            
            loadRequests();
            loadDashboardData();
            switchTab('requests');
        }

        function confirmRequest(requestId) {
            const requests = JSON.parse(localStorage.getItem('testRequests') || '[]');
            const request = requests.find(r => r.id === requestId);
            
            if (!request) return;
            
            request.status = 'confirmed';
            request.confirmedAt = new Date().toISOString();
            
            localStorage.setItem('testRequests', JSON.stringify(requests));
            
            showNotification(`–ó–∞—è–≤–∫–∞ ${requestId} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞`, 'success');
            loadRequests();
            loadDashboardData();
        }

        function generateConfirmationPDF(requestId) {
            const request = JSON.parse(localStorage.getItem('testRequests') || '[]')
                .find(r => r.id === requestId);
            
            if (!request) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // –®–∞–ø–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            doc.setFontSize(16);
            doc.text('–§–ì–ë–£ ¬´–ú–û–†–°–ü–ê–°–°–õ–£–ñ–ë–ê¬ª', 105, 20, { align: 'center' });
            doc.setFontSize(14);
            doc.text('–ì–ª–∞–≤–Ω—ã–π –º–æ—Ä—Å–∫–æ–π —Å–ø–∞—Å–∞—Ç–µ–ª—å–Ω–æ-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–µ–Ω—Ç—Ä', 105, 30, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text('–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ü–û–õ–£–ß–ï–ù–ò–Ø –¢–ï–°–¢–û–í–û–ì–û –°–ò–ì–ù–ê–õ–ê –°–°–¢–û', 105, 50, { align: 'center' });
            
            // –î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
            doc.setFontSize(10);
            doc.text(`–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}`, 20, 70);
            doc.text(`–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: ${request.id}`, 20, 80);
            doc.text(`–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏ –°–°–¢–û: ${request.stationNumber}`, 20, 90);
            doc.text(`–°—É–¥–Ω–æ: ${request.vesselName}`, 20, 100);
            doc.text(`MMSI: ${request.mmsi}`, 20, 110);
            doc.text(`IMO: ${request.imo || '–ù–µ —É–∫–∞–∑–∞–Ω'}`, 20, 120);
            doc.text(`–°—É–¥–æ–≤–ª–∞–¥–µ–ª–µ—Ü: ${request.shipOwner}`, 20, 130);
            doc.text(`–î–∞—Ç–∞/–≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞: ${formatDate(request.testDate)} ${request.testTime || ''}`, 20, 140);
            
            doc.text('–†–µ–∑—É–ª—å—Ç–∞—Ç: –¢–ï–°–¢ –ü–†–û–ô–î–ï–ù –£–°–ü–ï–®–ù–û', 20, 160);
            
            doc.text('–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –¥–µ–∂—É—Ä–Ω—ã–π –ì–ú–°–ö–¶', 20, 200);
            doc.text('_______________________', 20, 210);
            
            doc.save(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ_${request.id}.pdf`);
            showNotification('PDF –¥–æ–∫—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
        }

        async function sendToPoiskMore(signalId) {
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            const signal = signals.find(s => s.id === signalId);
            
            if (!signal) return;
            
            const result = await app.poiskMoreIntegration.sendToPoiskMore(signal);
            
            if (result.success) {
                signal.poiskMoreId = result.poiskMoreId;
                signal.sentToPoiskMore = true;
                localStorage.setItem('signals', JSON.stringify(signals));
                showNotification(result.message, 'success');
                loadSignals();
            }
        }

        function processEmailQueue() {
            const queue = app.emailProcessor.emailQueue;
            showNotification(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${queue.length} –ø–∏—Å–µ–º`, 'info');
        }

        async function syncWithPoiskMore() {
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            const unsynced = signals.filter(s => !s.sentToPoiskMore && !s.isTest);
            
            if (unsynced.length === 0) {
                showNotification('–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'info');
                return;
            }
            
            const results = await app.poiskMoreIntegration.syncBatch(unsynced);
            showNotification(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ${results.length} —Å–∏–≥–Ω–∞–ª–æ–≤`, 'success');
        }

        function generateTestData() {
            const testSignal = {
                id: `SIG-TEST-${Date.now()}`,
                stationNumber: '427309676',
                mmsi: '273456789',
                type: 'INMARSAT',
                coordinates: {
                    lat: 55.7558 + (Math.random() - 0.5) * 10,
                    lon: 37.6173 + (Math.random() - 0.5) * 10
                },
                receivedAt: new Date().toISOString(),
                isTest: true
            };
            
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            signals.push(testSignal);
            localStorage.setItem('signals', JSON.stringify(signals));
            
            showNotification('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã', 'success');
            loadSignals();
            loadDashboardData();
            
            if (window.mapManager && window.mapManager.map) {
                window.mapManager.loadSignalsToMap();
            }
        }

        function systemHealthCheck() {
            const checks = {
                localStorage: true,
                vessels: app.vesselDB.vessels.length > 0,
                autoConfirm: app.autoConfirmManager !== null,
                poiskMore: app.poiskMoreIntegration !== null
            };
            
            const allOk = Object.values(checks).every(v => v === true);
            showNotification(allOk ? '‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ' : '‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã', 
                           allOk ? 'success' : 'error');
        }

        function updateAutoConfirmStatus() {
            const statusElement = document.getElementById('auto-confirm-status');
            if (statusElement) {
                statusElement.textContent = app.autoConfirmManager.enabled ? '–í–ö–õ–Æ–ß–ï–ù' : '–û–¢–ö–õ–Æ–ß–ï–ù';
                statusElement.style.color = app.autoConfirmManager.enabled ? '#065f46' : '#991b1b';
            }
        }

        function toggleAutoConfirm() {
            const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');
            if (!password) return;
            
            const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∏–∑–º–µ–Ω–µ–Ω–∏—è:');
            if (!reason) return;
            
            try {
                const result = app.autoConfirmManager.toggleAutoConfirmation(password, reason, 'ADMIN');
                showNotification(result.message, 'success');
                updateAutoConfirmStatus();
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        function exportSettings() {
            const settings = {
                version: '1.0.0',
                exportDate: new Date().toISOString(),
                vessels: app.vesselDB.vessels,
                requests: JSON.parse(localStorage.getItem('testRequests') || '[]'),
                signals: JSON.parse(localStorage.getItem('signals') || '[]'),
                autoConfirmEnabled: app.autoConfirmManager.enabled
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ssto-settings-${Date.now()}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        function importSettings() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const settings = JSON.parse(event.target.result);
                        
                        if (settings.vessels) {
                            localStorage.setItem('vessels', JSON.stringify(settings.vessels));
                        }
                        if (settings.requests) {
                            localStorage.setItem('testRequests', JSON.stringify(settings.requests));
                        }
                        if (settings.signals) {
                            localStorage.setItem('signals', JSON.stringify(settings.signals));
                        }
                        
                        initializeApp();
                        showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                    } catch (error) {
                        showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', 'error');
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function viewRequest(requestId) {
            const request = JSON.parse(localStorage.getItem('testRequests') || '[]')
                .find(r => r.id === requestId);
            if (!request) return;
            
            alert(`–ó–∞—è–≤–∫–∞: ${request.id}\n–°—Ç–æ–π–∫–∞: ${request.stationNumber}\n–°—É–¥–Ω–æ: ${request.vesselName}\n–ú–úSI: ${request.mmsi}\n–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞: ${formatDate(request.testDate)}`);
        }

        function viewSignal(signalId) {
            const signal = JSON.parse(localStorage.getItem('signals') || '[]')
                .find(s => s.id === signalId);
            if (!signal) return;
            
            alert(`–°–∏–≥–Ω–∞–ª: ${signal.id}\n–°—Ç–æ–π–∫–∞: ${signal.stationNumber}\n–¢–∏–ø: ${signal.type}\n–ü–æ–ª—É—á–µ–Ω: ${formatDate(signal.receivedAt)}`);
        }

        function editTerminal(stationNumber) {
            const vessel = app.vesselDB.findByStationNumber(stationNumber);
            if (!vessel) return;
            
            const newName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–¥–Ω–∞:', vessel.name);
            if (newName && newName !== vessel.name) {
                vessel.name = newName;
                app.vesselDB.save();
                loadTerminals();
                showNotification('–¢–µ—Ä–º–∏–Ω–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            }
        }

        function testTerminal(stationNumber) {
            const vessel = app.vesselDB.findByStationNumber(stationNumber);
            if (!vessel) return;
            
            const testSignal = {
                id: `SIG-TEST-${Date.now()}`,
                stationNumber: stationNumber,
                mmsi: vessel.mmsi,
                type: vessel.satcomType,
                coordinates: {
                    lat: 55.7558 + (Math.random() - 0.5) * 10,
                    lon: 37.6173 + (Math.random() - 0.5) * 10
                },
                receivedAt: new Date().toISOString(),
                isTest: true
            };
            
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            signals.push(testSignal);
            localStorage.setItem('signals', JSON.stringify(signals));
            
            showNotification(`–¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç ${stationNumber} —Å–æ–∑–¥–∞–Ω`, 'success');
            loadSignals();
        }

        function addNewTerminal() {
            const stationNumber = prompt('–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏ (9 —Ü–∏—Ñ—Ä):');
            if (!stationNumber || !/^\d{9}$/.test(stationNumber)) {
                showNotification('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Å—Ç–æ–π–∫–∏', 'error');
                return;
            }
            
            const vesselName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–¥–Ω–∞:');
            const mmsi = prompt('MMSI (9 —Ü–∏—Ñ—Ä):');
            
            if (!vesselName || !mmsi) return;
            
            const vessel = {
                name: vesselName,
                mmsi: mmsi,
                stationNumbers: [stationNumber],
                satcomType: 'INMARSAT',
                owner: '–ù–µ —É–∫–∞–∑–∞–Ω',
                email: 'test@example.com'
            };
            
            app.vesselDB.addVessel(vessel);
            loadTerminals();
            showNotification('–¢–µ—Ä–º–∏–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        }

        function generateDailyReport() {
            const report = generateReportHTML('daily');
            document.getElementById('report-content').innerHTML = report;
        }

        function generateWeeklyReport() {
            const report = generateReportHTML('weekly');
            document.getElementById('report-content').innerHTML = report;
        }

        function generateMonthlyReport() {
            const report = generateReportHTML('monthly');
            document.getElementById('report-content').innerHTML = report;
        }

        function generateReportHTML(type) {
            const requests = JSON.parse(localStorage.getItem('testRequests') || '[]');
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            
            return `
                <h3>–û—Ç—á–µ—Ç: ${type === 'daily' ? '–°—É—Ç–æ—á–Ω—ã–π' : type === 'weekly' ? '–ù–µ–¥–µ–ª—å–Ω—ã–π' : '–ú–µ—Å—è—á–Ω—ã–π'}</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>–ó–∞—è–≤–æ–∫</h3>
                        <div class="value">${requests.length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</h3>
                        <div class="value">${requests.filter(r => r.status === 'confirmed').length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–°–∏–≥–Ω–∞–ª–æ–≤</h3>
                        <div class="value">${signals.length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–¢—Ä–µ–≤–æ–≥</h3>
                        <div class="value">${signals.filter(s => !s.isTest).length}</div>
                    </div>
                </div>
            `;
        }

        function exportReportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('–û—Ç—á–µ—Ç –¢–ï–°–¢ –°–°–¢–û', 105, 20, { align: 'center' });
            
            doc.setFontSize(10);

            doc.text(`–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${new Date().toLocaleDateString('ru-RU')}`, 20, 40);
            
            const requests = JSON.parse(localStorage.getItem('testRequests') || '[]');
            const signals = JSON.parse(localStorage.getItem('signals') || '[]');
            
            doc.text(`–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: ${requests.length}`, 20, 60);
            doc.text(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: ${requests.filter(r => r.status === 'confirmed').length}`, 20, 70);
            doc.text(`–í –æ–∂–∏–¥–∞–Ω–∏–∏: ${requests.filter(r => r.status === 'pending').length}`, 20, 80);
            doc.text(`–í—Å–µ–≥–æ —Å–∏–≥–Ω–∞–ª–æ–≤: ${signals.length}`, 20, 90);
            
            doc.save(`–û—Ç—á–µ—Ç_–°–°–¢–û_${Date.now()}.pdf`);
            showNotification('PDF –æ—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
        }

        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –†–ê–°–®–ò–†–ï–ù–ù–´–• –ö–û–ú–ü–û–ù–ï–ù–¢–û–í =====
        window.mapManager = new AdvancedMapManager();
        window.emailSender = new EmailAutoSender();
        window.excelLoader = new ExcelDataLoader();

        // ===== –û–ë–†–ê–ë–û–¢–ß–ò–ö –û–¢–ü–†–ê–í–ö–ò –§–û–†–ú–´ =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            initializeApp();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
            const requestForm = document.getElementById('request-form');
            if (requestForm) {
                requestForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    submitRequest();
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —Å–ø—É—Ç–Ω–∏–∫–æ–≤–æ–π —Å–≤—è–∑–∏
            const satcomRadios = document.querySelectorAll('input[name="satcom-type"]');
            satcomRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const stationLabel = document.querySelector('label[for="station-number"]');
                    if (stationLabel) {
                        if (e.target.value === 'INMARSAT') {
                            stationLabel.textContent = '–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏ –ò–ù–ú–ê–†–°–ê–¢:';
                        } else {
                            stationLabel.textContent = '–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏ –ò–†–ò–î–ò–£–ú:';
                        }
                    }
                });
            });
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
            setInterval(() => {
                if (app.currentTab === 'dashboard') {
                    loadDashboardData();
                }
            }, 30000);
            
            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
            document.addEventListener('keydown', (e) => {
                // Alt+N - –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                if (e.altKey && e.key === 'n') {
                    e.preventDefault();
                    switchTab('new-request');
                }
                
                // Alt+R - –û–±–Ω–æ–≤–∏—Ç—å
                if (e.altKey && e.key === 'r') {
                    e.preventDefault();
                    location.reload();
                }
                
                // Alt+H - –°–ø—Ä–∞–≤–∫–∞
                if (e.altKey && e.key === 'h') {
                    e.preventDefault();
                    showHelp();
                }
                
                // Alt+E - –≠–∫—Å–ø–æ—Ä—Ç
                if (e.altKey && e.key === 'e') {
                    e.preventDefault();
                    exportSettings();
                }
                
                // Alt+I - –ò–º–ø–æ—Ä—Ç
                if (e.altKey && e.key === 'i') {
                    e.preventDefault();
                    importSettings();
                }
            });
            
            // –ü–æ–∫–∞–∑ –≤–µ—Ä—Å–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏
            console.log('%c–ú–û–î–£–õ–¨ –¢–ï–°–¢ –°–°–¢–û v1.0.0', 'color: #667eea; font-size: 20px; font-weight: bold;');
            console.log('Build: 2025.01.09');
            console.log('¬© 2025 –ì–ê–ú–¶ –†–æ—Å–º–æ—Ä—Ä–µ—á—Ñ–ª–æ—Ç');
        });

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–ø—Ä–∞–≤–∫–∏
        function showHelp() {
            const helpText = `
                –ú–û–î–£–õ–¨ –¢–ï–°–¢ –°–°–¢–û v1.0.0
                =====================================
                
                –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò:
                ‚Ä¢ –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –°–°–¢–û
                ‚Ä¢ –ü—Ä–∏–µ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
                ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (–ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏)
                ‚Ä¢ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –ü–æ–∏—Å–∫-–ú–æ—Ä–µ
                ‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –∏ PDF –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                ‚Ä¢ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel
                
                –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò:
                ‚Ä¢ Alt+N - –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                ‚Ä¢ Alt+R - –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                ‚Ä¢ Alt+H - –°–ø—Ä–∞–≤–∫–∞
                ‚Ä¢ Alt+E - –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
                ‚Ä¢ Alt+I - –ò–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
                
                –í–ê–ñ–ù–û:
                –ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏ –°–°–¢–û - –∫–ª—é—á–µ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä!
                
                –ü–æ–¥–¥–µ—Ä–∂–∫–∞: support@morflot.ru
            `;
            
            alert(helpText);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', (e) => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const pendingRequests = JSON.parse(localStorage.getItem('testRequests') || '[]')
                .filter(r => r.status === 'pending');
            
            if (pendingRequests.length > 0) {
                e.preventDefault();
                e.returnValue = '–ï—Å—Ç—å –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?';
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        window.addEventListener('error', (e) => {
            console.error('‚ùå –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error);
        });

        console.log('‚úÖ –°–∫—Ä–∏–ø—Ç –º–æ–¥—É–ª—è –¢–ï–°–¢ –°–°–¢–û –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∂–µ–Ω');
    </script>
</body>
</html>