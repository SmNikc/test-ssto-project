# Эволюция нормализатора строк ССТО

Документ фиксирует эволюцию утилиты `StringNormalizer`, используемой в backend для
нормализации терминальных номеров, идентификаторов и имён судов. Сводка объединяет
возможности текущей реализации и предыдущих версий (1–3), чтобы QA и разработчики
понимали, какие сценарии уже покрыты и какие расширения допустимы.

## Итоговые возможности текущей реализации

| Возможность | Описание |
|-------------|----------|
| Нормализация терминальных номеров | Приведение SSAS/IMN/Iridium кодов к формату `A-Z0-9` с удалением пробелов и пунктуации. |
| Нормализация MMSI/IMO и других числовых идентификаторов | Извлечение только цифр без потери ведущих нулей. |
| Нормализация имён судов | Транслитерация RU→LAT, удаление диакритики, пунктуации и лишних пробелов, перевод в upper case. |
| Левенштейн и коэффициент сходства | Базовые функции для оценки близости нормализованных названий судов. |
| Расширяемая карта транслитерации | Возможность добавлять новые соответствия без перезаписи существующих ключей. |
| Вспомогательные утилиты | Публичные функции `toAsciiUpper` и `stripDiacritics` для отчётов и тестов. |

## История версий

| Версия | Период | Ключевые изменения | Риск/ограничения |
|--------|--------|--------------------|------------------|
| 1 | 2024‑06 | Базовая нормализация имён: ASCII, пробелы, upper case. Без отдельной карты транслитерации и без метрик сходства. | Поддерживались только латиница и простые случаи, кириллица терялась. |
| 2 | 2024‑11 | Добавлена карта RU→LAT и функция `similarity` на основе Левенштейна для сравнения имён. | Карта транслитерации была «жёстко» зашита внутри `normalizeName`, расширение требовало правок кода. |
| 3 (текущая база) | 2025‑10 | Выделена `CYR_MAP`, добавлен метод `extendTransliteration`, публичные утилиты `toAsciiUpper` и `stripDiacritics`. | Требует контроля обратной совместимости: новые ключи можно только добавлять. |
| Актуальная «сводная» версия | 2025‑10 → | Сохраняет все возможности версии 3 и рекомендует расширения через `extendTransliteration`; остальные правила добавляются в конец файла без изменения API. | При добавлении новых алфавитов нужно следить за тестами matcher'а и отчётами. |

## Практические рекомендации

1. **Расширение карты** — используйте `extendTransliteration`, чтобы не трогать базовый словарь и сохранить стабильность API.  
2. **Новые форматы идентификаторов** — изменяйте регулярные выражения в `normalizeTerminal`/`normalizeIdentifier` только при наличии подтверждённых примеров.  
3. **Метрики сходства** — пороги `similarity` должны проверяться в модульных и контрактных тестах matcher'а.  
4. **Импортируемые утилиты** — `toAsciiUpper` и `stripDiacritics` предназначены для отчётов и PDF, не удаляйте их без миграционного плана.

> NB: Все новые правила трансформации добавляйте в конец `string-normalizer.ts`, соблюдая обратную совместимость с прошлым поведением.
