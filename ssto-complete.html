<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система ТЕСТ ССТО - Поиск-Море v2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            color: #4a5568;
        }

        .tab:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 14px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 12px;
            opacity: 0.8;
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group.highlight {
            grid-column: 1 / -1;
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ff6b6b;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .highlight label {
            color: #d32f2f;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .highlight input {
            font-size: 20px;
            font-weight: bold;
            font-family: monospace;
            background: white;
            border: 3px solid #ff6b6b;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        button.danger {
            background: linear-gradient(135deg, #f56565, #c53030);
        }

        button.success {
            background: linear-gradient(135deg, #48bb78, #2f855a);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f7fafc;
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status.confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .status.rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .close {
            font-size: 30px;
            color: #a0aec0;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #4a5568;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .terminal-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .terminal-type.inmarsat {
            background: #e0f2fe;
            color: #0369a1;
        }

        .terminal-type.iridium {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert.danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .email-control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 999;
        }

        .email-control-panel h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .email-status {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            form {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo">СС</div>
                Система ТЕСТ ССТО - Поиск-Море
            </h1>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">📊 Главная</button>
                <button class="tab" onclick="switchTab('new-request')">➕ Новая заявка</button>
                <button class="tab" onclick="switchTab('requests')">📋 Заявки</button>
                <button class="tab" onclick="switchTab('signals')">📡 Сигналы</button>
                <button class="tab" onclick="switchTab('terminals')">🔧 Терминалы</button>
                <button class="tab" onclick="switchTab('map')">🗺️ Карта</button>
                <button class="tab" onclick="switchTab('reports')">📈 Отчеты</button>
            </div>
        </header>
<!-- Главная панель -->
        <div id="dashboard" class="content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Активные заявки</h3>
                    <div class="value" id="stat-active">5</div>
                    <div class="change">↑ +2 за сегодня</div>
                </div>
                <div class="stat-card">
                    <h3>Обработано сигналов</h3>
                    <div class="value" id="stat-signals">127</div>
                    <div class="change">↑ +15 за неделю</div>
                </div>
                <div class="stat-card">
                    <h3>Сформировано отчетов</h3>
                    <div class="value" id="stat-reports">42</div>
                    <div class="change">↑ +5 за месяц</div>
                </div>
                <div class="stat-card">
                    <h3>Активных терминалов</h3>
                    <div class="value" id="stat-terminals">89</div>
                    <div class="change">23 ИНМАРСАТ, 66 ИРИДИУМ</div>
                </div>
            </div>

            <div class="alert info">
                <span>ℹ️</span>
                <div>
                    <strong>Система работает в штатном режиме</strong><br>
                    Последняя проверка: <span id="last-check">сегодня в 14:30</span>
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="switchTab('new-request')">Создать заявку</button>
                <button class="secondary" onclick="emailProcessor.checkEmails()">📧 Обработать Email</button>
                <button class="success" onclick="runSystemTest()">🔧 Тест системы</button>
                <button onclick="showVesselDirectory()">📚 Справочник судов</button>
            </div>
        </div>

        <!-- Новая заявка -->
        <div id="new-request" class="content">
            <h2>Создание новой заявки на тестирование ССТО</h2>
            
            <form id="request-form" onsubmit="submitRequest(event)">
                <div class="form-group full-width highlight">
                    <label>
                        ⚠️ НОМЕР СТОЙКИ ССТО (ГЛАВНЫЙ ИДЕНТИФИКАТОР)
                    </label>
                    <input 
                        type="text" 
                        name="terminalNumber" 
                        placeholder="Например: 427399999" 
                        required
                        pattern="[0-9]{9}"
                        title="9-значный номер терминала"
                        onblur="autoFillFromDatabase(this.value)"
                    >
                    <small style="color: #d32f2f; margin-top: 5px;">
                        Уникальный номер терминала ИНМАРСАТ/ИРИДИУМ - единственный идентификатор для сопоставления заявки и сигнала
                    </small>
                </div>

                <div class="form-group">
                    <label>Тип терминала</label>
                    <select name="terminalType" required>
                        <option value="INMARSAT">ИНМАРСАТ</option>
                        <option value="IRIDIUM">ИРИДИУМ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Название судна</label>
                    <input type="text" name="vesselName" placeholder="Например: ВОЛГА-1" required>
                </div>

                <div class="form-group">
                    <label>MMSI</label>
                    <input type="text" name="mmsi" placeholder="273456789" pattern="[0-9]{9}" required>
                </div>

                <div class="form-group">
                    <label>IMO</label>
                    <input type="text" name="imo" placeholder="1234567" pattern="[0-9]{7}">
                </div>

                <div class="form-group">
                    <label>Дата теста</label>
                    <input type="date" name="testDate" required>
                </div>

                <div class="form-group">
                    <label>Время теста (необязательно)</label>
                    <input type="time" name="testTime">
                </div>

                <div class="form-group">
                    <label>Контактное лицо</label>
                    <input type="text" name="contactPerson" placeholder="Капитан Иванов И.И." required>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" placeholder="captain@ship.ru" required>
                </div>

                <div class="form-group">
                    <label>Телефон</label>
                    <input type="tel" name="phone" placeholder="+7 (999) 123-45-67">
                </div>

                <div class="form-group full-width">
                    <label>Дополнительная информация</label>
                    <textarea name="notes" rows="3" placeholder="Особые условия тестирования..."></textarea>
                </div>

                <div class="form-group full-width">
                    <button type="submit">Создать заявку</button>
                </div>
            </form>
        </div>

        <!-- Список заявок -->
        <div id="requests" class="content">
            <h2>Список заявок на тестирование</h2>
            
            <div class="action-buttons">
                <button onclick="filterRequests('all')">Все</button>
                <button class="secondary" onclick="filterRequests('pending')">Ожидающие</button>
                <button class="success" onclick="filterRequests('confirmed')">Подтвержденные</button>
                <button class="danger" onclick="filterRequests('rejected')">Отклоненные</button>
                <button onclick="showVesselDirectory()">📚 Справочник судов</button>
            </div>

            <table id="requests-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Номер стойки</th>
                        <th>Тип</th>
                        <th>Судно</th>
                        <th>MMSI</th>
                        <th>Дата теста</th>
                        <th>Статус</th>
                        <th>Сигнал</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="requests-tbody">
                    <!-- Динамически заполняется -->
                </tbody>
            </table>
        </div>

        <!-- Сигналы -->
        <div id="signals" class="content">
            <h2>Мониторинг сигналов ССТО</h2>
            
            <div class="alert warning" id="real-alert" style="display: none;">
                <span>⚠️</span>
                <div>
                    <strong>Внимание!</strong> Обнаружен реальный сигнал тревоги!<br>
                    <span id="real-alert-details"></span>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Время</th>
                        <th>Терминал</th>
                        <th>Тип сигнала</th>
                        <th>Судно</th>
                        <th>Координаты</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="signals-tbody">
                    <!-- Динамически заполняется -->
                </tbody>
            </table>
        </div>

        <!-- Справочник терминалов -->
        <div id="terminals" class="content">
            <h2>Справочник терминалов ССТО</h2>
            
            <div class="action-buttons">
                <button onclick="showVesselDirectory()">📚 Полный справочник судов</button>
                <button class="secondary" onclick="checkAllTestDates()">🔍 Проверить сроки тестов</button>
                <button class="success" onclick="importVesselData()">📤 Импорт из Excel</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ИНМАРСАТ</h3>
                    <div class="value">23</div>
                    <div class="change">Активных терминалов</div>
                </div>
                <div class="stat-card">
                    <h3>ИРИДИУМ</h3>
                    <div class="value">66</div>
                    <div class="change">Активных терминалов</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Номер терминала</th>
                        <th>Тип</th>
                        <th>Текущее судно</th>
                        <th>MMSI</th>
                        <th>Владелец</th>
                        <th>Последний тест</th>
                        <th>История</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody id="terminals-tbody">
                    <!-- Динамически заполняется из базы данных -->
                </tbody>
            </table>
        </div>

        <!-- Карта -->
        <div id="map-container" class="content">
            <h2>Карта сигналов ССТО</h2>
            <div id="map"></div>
            <div class="action-buttons">
                <button onclick="centerMap()">🎯 Центрировать</button>
                <button class="secondary" onclick="toggleSignalTypes()">🔄 Переключить типы</button>
                <button class="success" onclick="exportMapData()">📥 Экспорт данных</button>
            </div>
        </div>

        <!-- Отчеты -->
        <div id="reports" class="content">
            <h2>Формирование отчетов</h2>
            
            <div class="form-group">
                <label>Период отчета</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="report-start">
                    <input type="date" id="report-end">
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="generateReport()">📊 Сформировать отчет</button>
                <button class="secondary" onclick="generateStatistics()">📈 Статистика</button>
                <button class="success" onclick="exportReport()">📥 Экспорт в PDF</button>
                <button onclick="showVesselDirectory()">📚 Справочник судов</button>
            </div>

            <div id="report-content" style="margin-top: 20px;">
                <!-- Динамически заполняется -->
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Заголовок</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body">
                <!-- Динамическое содержимое -->
            </div>
        </div>
    </div>

    <!-- Панель управления Email -->
    <div class="email-control-panel">
        <h4>📧 Email обработка</h4>
        <button onclick="emailProcessor.startAutoProcessing()" style="margin-right: 10px;">▶️ Запустить</button>
        <button onclick="emailProcessor.stopAutoProcessing()" style="margin-right: 10px;">⏸️ Остановить</button>
        <button onclick="emailProcessor.checkEmails()">🔄 Проверить сейчас</button>
        <div class="email-status" id="email-status">Статус: Ожидание</div>
    </div>
<script>
        // Инициализация данных
        let requests = [];
        let signals = [];
        let terminals = [];
        let map = null;
        let markers = [];

        // EMAIL PROCESSING MODULE
        class EmailProcessor {
            constructor() {
                this.emailQueue = [];
                this.isProcessing = false;
                this.processInterval = null;
                this.patterns = {
                    terminal: /(?:терминал|стойка|terminal|ИНМАРСАТ|ИРИДИУМ|INMARSAT|IRIDIUM)[\s:№#]*(\d{9})/i,
                    mmsi: /MMSI[\s:]*(\d{9})/i,
                    vessel: /(?:судно|vessel|ship)[\s:]*([А-Яа-я\w\-\s]+)/i,
                    testDate: /(?:дата теста|test date)[\s:]*(\d{2}[\.\/]\d{2}[\.\/]\d{4})/i,
                    signal: /(?:TEST|REAL\s*ALERT|PIRACY|DISTRESS)/i
                };
            }

            startAutoProcessing(intervalSeconds = 30) {
                if (this.processInterval) return;
                
                console.log('📧 Запущена автоматическая обработка email');
                document.getElementById('email-status').textContent = 'Статус: Активна (проверка каждые ' + intervalSeconds + ' сек)';
                
                this.processInterval = setInterval(() => {
                    this.checkEmails();
                }, intervalSeconds * 1000);
                
                this.checkEmails();
            }

            stopAutoProcessing() {
                if (this.processInterval) {
                    clearInterval(this.processInterval);
                    this.processInterval = null;
                    console.log('📧 Остановлена автоматическая обработка email');
                    document.getElementById('email-status').textContent = 'Статус: Остановлена';
                }
            }

            async checkEmails() {
                document.getElementById('email-status').textContent = 'Статус: Проверка почты...';
                
                const mockEmails = this.generateMockEmails();
                
                if (mockEmails.length > 0) {
                    console.log(`📧 Получено ${mockEmails.length} новых писем`);
                    mockEmails.forEach(email => this.emailQueue.push(email));
                    this.processQueue();
                } else {
                    document.getElementById('email-status').textContent = 'Статус: Нет новых писем';
                    setTimeout(() => {
                        if (this.processInterval) {
                            document.getElementById('email-status').textContent = 'Статус: Активна';
                        } else {
                            document.getElementById('email-status').textContent = 'Статус: Ожидание';
                        }
                    }, 2000);
                }
            }

            async processQueue() {
                if (this.isProcessing || this.emailQueue.length === 0) return;
                
                this.isProcessing = true;
                document.getElementById('email-status').textContent = 'Статус: Обработка писем...';
                
                const results = {
                    processed: 0,
                    created: 0,
                    rejected: 0,
                    signals: 0
                };

                while (this.emailQueue.length > 0) {
                    const email = this.emailQueue.shift();
                    const result = await this.processEmail(email);
                    
                    results.processed++;
                    if (result.type === 'request') {
                        results.created++;
                    } else if (result.type === 'signal') {
                        results.signals++;
                    } else if (result.type === 'rejected') {
                        results.rejected++;
                    }
                }

                this.isProcessing = false;
                this.showProcessingResults(results);
            }

            async processEmail(email) {
                const parsed = this.parseEmail(email);
                
                if (parsed.signalType) {
                    return this.processSignal(parsed);
                } else if (parsed.terminal) {
                    return this.processRequest(parsed);
                } else {
                    return { type: 'rejected', reason: 'Неполные данные' };
                }
            }

            parseEmail(email) {
                const body = email.body || '';
                const subject = email.subject || '';
                const fullText = subject + ' ' + body;
                
                const parsed = {
                    emailFrom: email.from,
                    emailDate: email.date,
                    subject: subject
                };

                const terminalMatch = fullText.match(this.patterns.terminal);
                if (terminalMatch) parsed.terminal = terminalMatch[1];

                const mmsiMatch = fullText.match(this.patterns.mmsi);
                if (mmsiMatch) parsed.mmsi = mmsiMatch[1];

                const vesselMatch = fullText.match(this.patterns.vessel);
                if (vesselMatch) parsed.vessel = vesselMatch[1].trim();

                const dateMatch = fullText.match(this.patterns.testDate);
                if (dateMatch) {
                    const [day, month, year] = dateMatch[1].split(/[\.\/]/);
                    parsed.testDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }

                const signalMatch = fullText.match(this.patterns.signal);
                if (signalMatch) parsed.signalType = signalMatch[0];

                if (/ИРИДИУМ|IRIDIUM/i.test(fullText)) {
                    parsed.terminalType = 'IRIDIUM';
                } else {
                    parsed.terminalType = 'INMARSAT';
                }

                return parsed;
            }

            processSignal(data) {
                const signal = {
                    id: Date.now(),
                    terminalNumber: data.terminal,
                    signalType: data.signalType,
                    vesselName: data.vessel || 'Неизвестно',
                    mmsi: data.mmsi,
                    coordinates: {
                        lat: 55.7558 + Math.random() * 10,
                        lng: 37.6173 + Math.random() * 10
                    },
                    receivedAt: new Date().toISOString(),
                    status: data.signalType === 'TEST' ? 'confirmed' : 'processing'
                };

                signals.push(signal);
                localStorage.setItem('ssasSignals', JSON.stringify(signals));

                if (data.signalType !== 'TEST') {
                    this.handleRealAlert(signal);
                }

                this.matchSignalToRequest(signal);

                updateStats();
                loadSignals();

                return { type: 'signal', data: signal };
            }

            processRequest(data) {
                if (!data.terminal || !data.vessel) {
                    return { type: 'rejected', reason: 'Отсутствуют обязательные поля' };
                }

                const newRequest = {
                    id: Date.now(),
                    terminalNumber: data.terminal,
                    terminalType: data.terminalType || 'INMARSAT',
                    vesselName: data.vessel,
                    mmsi: data.mmsi || '',
                    testDate: data.testDate || new Date().toISOString().split('T')[0],
                    status: 'pending',
                    signalReceived: false,
                    contactPerson: data.emailFrom.split('@')[0],
                    email: data.emailFrom,
                    source: 'email',
                    createdAt: new Date().toISOString()
                };

                requests.push(newRequest);
                localStorage.setItem('ssasRequests', JSON.stringify(requests));

                updateStats();
                if (document.getElementById('requests').classList.contains('active')) {
                    loadRequests();
                }

                return { type: 'request', data: newRequest };
            }

            matchSignalToRequest(signal) {
                const matchingRequest = requests.find(r => 
                    r.terminalNumber === signal.terminalNumber && 
                    r.status === 'pending'
                );

                if (matchingRequest) {
                    matchingRequest.status = 'confirmed';
                    matchingRequest.signalReceived = true;
                    localStorage.setItem('ssasRequests', JSON.stringify(requests));
                    console.log(`✅ Сигнал сопоставлен с заявкой #${matchingRequest.id}`);
                }
            }

            handleRealAlert(signal) {
                console.error('🚨 РЕАЛЬНАЯ ТРЕВОГА!', signal);
                
                const alertDiv = document.getElementById('real-alert');
                const alertDetails = document.getElementById('real-alert-details');
                alertDetails.textContent = `Терминал: ${signal.terminalNumber}, Судно: ${signal.vesselName}, Координаты: ${signal.coordinates.lat.toFixed(4)}° N, ${signal.coordinates.lng.toFixed(4)}° E`;
                alertDiv.style.display = 'flex';
                
                this.sendToPoiskMore(signal);
            }

            sendToPoiskMore(signal) {
                console.log('📤 Отправка в Поиск-Море:', signal);
                
                showModal('Передача в Поиск-Море', `
                    <div class="alert warning">
                        <span>⚠️</span>
                        <div>
                            <strong>Реальный сигнал тревоги передан в систему Поиск-Море!</strong><br>
                            Терминал: ${signal.terminalNumber}<br>
                            Судно: ${signal.vesselName}<br>
                            Координаты: ${signal.coordinates.lat.toFixed(4)}° N, ${signal.coordinates.lng.toFixed(4)}° E<br>
                            Статус: Обрабатывается дежурной сменой
                        </div>
                    </div>
                `);
            }

            generateMockEmails() {
                const chance = Math.random();
                if (chance > 0.7) {
                    return [{
                        from: `captain${Math.floor(Math.random() * 100)}@ship.ru`,
                        subject: 'Заявка на тест ССТО',
                        body: `Прошу провести тестирование системы ССТО.
                               Терминал: ${427300000 + Math.floor(Math.random() * 100000)}
                               Судно: ТЕСТ-${Math.floor(Math.random() * 100)}
                               MMSI: ${273000000 + Math.floor(Math.random() * 100000)}
                               Тип: ${Math.random() > 0.5 ? 'ИНМАРСАТ' : 'ИРИДИУМ'}
                               Дата теста: ${new Date().toLocaleDateString('ru-RU')}`,
                        date: new Date().toISOString()
                    }];
                } else if (chance > 0.5) {
                    return [{
                        from: 'ssas@terminal.com',
                        subject: 'SSAS TEST SIGNAL',
                        body: `TEST
                               Terminal: ${427300000 + Math.floor(Math.random() * 100000)}
                               Vessel: СИГНАЛ-${Math.floor(Math.random() * 100)}
                               MMSI: ${273000000 + Math.floor(Math.random() * 100000)}
                               Position: ${(55 + Math.random() * 10).toFixed(4)}N ${(37 + Math.random() * 10).toFixed(4)}E`,
                        date: new Date().toISOString()
                    }];
                } else if (chance > 0.45) {
                    return [{
                        from: 'ssas@terminal.com',
                        subject: 'SSAS REAL ALERT',
                        body: `REAL ALERT - PIRACY
                               Terminal: ${427399888}
                               Vessel: ТРЕВОГА-${Math.floor(Math.random() * 10)}
                               MMSI: ${273999888}
                               Position: ${(59 + Math.random() * 2).toFixed(4)}N ${(30 + Math.random() * 2).toFixed(4)}E`,
                        date: new Date().toISOString()
                    }];
                }
                return [];
            }

            showProcessingResults(results) {
                if (results.processed > 0) {
                    const message = `
                        📧 Обработка email завершена:
                        • Обработано писем: ${results.processed}
                        • Создано заявок: ${results.created}
                        • Получено сигналов: ${results.signals}
                        • Отклонено: ${results.rejected}
                    `;
                    console.log(message);
                    
                    showModal('Результаты обработки Email', `
                        <div class="alert ${results.created > 0 || results.signals > 0 ? 'success' : 'info'}">
                            <span>${results.created > 0 || results.signals > 0 ? '✅' : 'ℹ️'}</span>
                            <div>
                                <strong>Обработка email завершена</strong><br>
                                Обработано писем: ${results.processed}<br>
                                Создано заявок: ${results.created}<br>
                                Получено сигналов: ${results.signals}<br>
                                Отклонено: ${results.rejected}
                            </div>
                        </div>
                    `);
                    
                    updateStats();
                    if (document.getElementById('requests').classList.contains('active')) {
                        loadRequests();
                    }
                    
                    document.getElementById('email-status').textContent = this.processInterval ? 'Статус: Активна' : 'Статус: Ожидание';
                }
            }
        }

        // СПРАВОЧНЫЙ МОДУЛЬ ДАННЫХ О СУДАХ И ВЛАДЕЛЬЦАХ
class VesselDatabase {
    constructor() {
        // Данные из Excel файла (пример структуры на основе типичного журнала ССТО)
        this.vessels = [
            {
                imo: '9234567',
                mmsi: '273456789',
                vesselName: 'ВОЛГА-1',
                owner: 'ООО "Волжское пароходство"',
                terminalNumber: '427399999',
                terminalType: 'INMARSAT',
                responsiblePerson: 'Иванов Иван Иванович',
                email: 'ivanov@volga-ship.ru',
                phone: '+7 (846) 123-45-67',
                lastTestDate: '2024-09-06',
                testHistory: [
                    { date: '2024-09-06', status: 'success', signal: 'received' },
                    { date: '2023-09-05', status: 'success', signal: 'received' },
                    { date: '2022-09-04', status: 'success', signal: 'received' }
                ]
            },
            {
                imo: '9234568',
                mmsi: '273456790',
                vesselName: 'НЕВА-2',
                owner: 'АО "Северное речное пароходство"',
                terminalNumber: '427399998',
                terminalType: 'IRIDIUM',
                responsiblePerson: 'Петров Петр Петрович',
                email: 'petrov@neva-ship.ru',
                phone: '+7 (812) 234-56-78',
                lastTestDate: '2024-09-05',
                testHistory: [
                    { date: '2024-09-05', status: 'success', signal: 'received' },
                    { date: '2023-09-06', status: 'success', signal: 'received' }
                ]
            },
            {
                imo: '9234569',
                mmsi: '273456791',
                vesselName: 'ДУНАЙ-3',
                owner: 'ООО "Дунайское пароходство"',
                terminalNumber: '427399997',
                terminalType: 'INMARSAT',
                responsiblePerson: 'Сидоров Сидор Сидорович',
                email: 'sidorov@dunay.ru',
                phone: '+7 (863) 345-67-89',
                lastTestDate: '2024-09-04',
                testHistory: [
                    { date: '2024-09-04', status: 'pending', signal: 'not_received' }
                ]
            }
        ];

        // Загрузка дополнительных данных из localStorage если есть
        const storedVessels = localStorage.getItem('vesselDatabase');
        if (storedVessels) {
            this.vessels = JSON.parse(storedVessels);
        } else {
            // Сохраняем начальные данные
            localStorage.setItem('vesselDatabase', JSON.stringify(this.vessels));
        }
    }

    // Поиск судна по различным параметрам
    findVessel(searchParam, searchType = 'auto') {
        if (searchType === 'auto') {
            // Автоопределение типа поиска
            if (/^\d{7}$/.test(searchParam)) {
                searchType = 'imo';
            } else if (/^\d{9}$/.test(searchParam)) {
                // Может быть MMSI или номер терминала
                const byMMSI = this.vessels.find(v => v.mmsi === searchParam);
                const byTerminal = this.vessels.find(v => v.terminalNumber === searchParam);
                return byMMSI || byTerminal || null;
            } else {
                searchType = 'name';
            }
        }

        switch(searchType) {
            case 'imo':
                return this.vessels.find(v => v.imo === searchParam);
            case 'mmsi':
                return this.vessels.find(v => v.mmsi === searchParam);
            case 'terminal':
                return this.vessels.find(v => v.terminalNumber === searchParam);
            case 'name':
                return this.vessels.find(v => 
                    v.vesselName.toLowerCase().includes(searchParam.toLowerCase())
                );
            default:
                return null;
        }
    }

    // Получение истории тестов судна
    getTestHistory(terminalNumber) {
        const vessel = this.findVessel(terminalNumber, 'terminal');
        return vessel ? vessel.testHistory : [];
    }

    // Добавление нового судна
    addVessel(vesselData) {
        this.vessels.push(vesselData);
        localStorage.setItem('vesselDatabase', JSON.stringify(this.vessels));
    }

    // Обновление данных судна
    updateVessel(terminalNumber, updateData) {
        const index = this.vessels.findIndex(v => v.terminalNumber === terminalNumber);
        if (index !== -1) {
            this.vessels[index] = { ...this.vessels[index], ...updateData };
            localStorage.setItem('vesselDatabase', JSON.stringify(this.vessels));
            return true;
        }
        return false;
    }

    // Получение всех судов
    getAllVessels() {
        return this.vessels;
    }

    // Проверка необходимости следующего теста
    checkTestDue(terminalNumber) {
        const vessel = this.findVessel(terminalNumber, 'terminal');
        if (!vessel || !vessel.lastTestDate) return true;

        const lastTest = new Date(vessel.lastTestDate);
        const now = new Date();
        const monthsSinceLastTest = (now - lastTest) / (1000 * 60 * 60 * 24 * 30);
        
        return monthsSinceLastTest >= 11; // Предупреждение за месяц до истечения года
    }

    // Экспорт данных в формате для отчетов
    exportForReport(format = 'json') {
        if (format === 'json') {
            return JSON.stringify(this.vessels, null, 2);
        } else if (format === 'csv') {
            const headers = 'IMO,MMSI,Название,Владелец,Терминал,Тип,Ответственный,Email,Телефон,Последний тест\n';
            const rows = this.vessels.map(v => 
                `${v.imo},${v.mmsi},${v.vesselName},${v.owner},${v.terminalNumber},${v.terminalType},${v.responsiblePerson},${v.email},${v.phone},${v.lastTestDate}`
            ).join('\n');
            return headers + rows;
        }
    }
}

// Создаем экземпляр базы данных судов
const vesselDB = new VesselDatabase();

// Функция автозаполнения формы при вводе номера терминала
function autoFillFromDatabase(terminalNumber) {
    const vessel = vesselDB.findVessel(terminalNumber, 'terminal');
    if (vessel) {
        // Заполняем форму данными из базы
        document.querySelector('input[name="vesselName"]').value = vessel.vesselName;
        document.querySelector('input[name="mmsi"]').value = vessel.mmsi;
        document.querySelector('input[name="imo"]').value = vessel.imo;
        document.querySelector('select[name="terminalType"]').value = vessel.terminalType;
        document.querySelector('input[name="contactPerson"]').value = vessel.responsiblePerson;
        document.querySelector('input[name="email"]').value = vessel.email;
        document.querySelector('input[name="phone"]').value = vessel.phone;
        
        // Показываем информацию о владельце
        showModal('Данные из справочника', `
            <div class="alert info">
                <span>ℹ️</span>
                <div>
                    <strong>Судно найдено в базе данных!</strong><br>
                    Владелец: ${vessel.owner}<br>
                    Последний тест: ${vessel.lastTestDate}<br>
                    ${vesselDB.checkTestDue(terminalNumber) ? 
                        '<span style="color: red;">⚠️ Требуется проведение годового теста!</span>' : 
                        '<span style="color: green;">✅ Годовой тест проведен вовремя</span>'}
                </div>
            </div>
        `);
    }
}

// Функция показа справочника судов
function showVesselDirectory() {
    const vessels = vesselDB.getAllVessels();
    const tableRows = vessels.map(v => `
        <tr>
            <td>${v.imo}</td>
            <td>${v.mmsi}</td>
            <td><strong>${v.vesselName}</strong></td>
            <td>${v.owner}</td>
            <td><strong>${v.terminalNumber}</strong></td>
            <td><span class="terminal-type ${v.terminalType.toLowerCase()}">${v.terminalType}</span></td>
            <td>${v.responsiblePerson}</td>
            <td>${v.email}</td>
            <td>${v.phone}</td>
            <td>${v.lastTestDate}</td>
            <td>
                ${vesselDB.checkTestDue(v.terminalNumber) ? 
                    '<span class="status rejected">Требуется</span>' : 
                    '<span class="status confirmed">В срок</span>'}
            </td>
            <td>
                <button onclick="viewVesselHistory('${v.terminalNumber}')">История</button>
                <button onclick="createRequestFromDirectory('${v.terminalNumber}')">Создать заявку</button>
            </td>
        </tr>
    `).join('');

    showModal('Справочник судов и владельцев', `
        <div style="max-width: 100%; overflow-x: auto;">
            <table style="width: 100%; font-size: 12px;">
                <thead>
                    <tr>
                        <th>IMO</th>
                        <th>MMSI</th>
                        <th>Судно</th>
                        <th>Владелец</th>
                        <th>Терминал</th>
                        <th>Тип</th>
                        <th>Ответственный</th>
                        <th>Email</th>
                        <th>Телефон</th>
                        <th>Последний тест</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
        <div class="action-buttons" style="margin-top: 20px;">
            <button onclick="exportVesselData('json')">📥 Экспорт JSON</button>
            <button onclick="exportVesselData('csv')">📥 Экспорт CSV</button>
            <button onclick="importVesselData()">📤 Импорт данных</button>
        </div>
    `);
}

// Функция просмотра истории судна
function viewVesselHistory(terminalNumber) {
    const vessel = vesselDB.findVessel(terminalNumber, 'terminal');
    if (!vessel) return;

    const historyRows = vessel.testHistory.map(h => `
        <tr>
            <td>${h.date}</td>
            <td><span class="status ${h.status === 'success' ? 'confirmed' : 'pending'}">${h.status}</span></td>
            <td>${h.signal === 'received' ? '✅ Получен' : '❌ Не получен'}</td>
        </tr>
    `).join('');

    showModal(`История тестов: ${vessel.vesselName}`, `
        <div class="alert info">
            <strong>Судно:</strong> ${vessel.vesselName}<br>
            <strong>IMO:</strong> ${vessel.imo}<br>
            <strong>MMSI:</strong> ${vessel.mmsi}<br>
            <strong>Владелец:</strong> ${vessel.owner}<br>
            <strong>Терминал:</strong> ${vessel.terminalNumber}
        </div>
        
        <h3 style="margin-top: 20px;">История тестирований:</h3>
        <table style="width: 100%; margin-top: 10px;">
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Статус</th>
                    <th>Сигнал</th>
                </tr>
            </thead>
            <tbody>
                ${historyRows}
            </tbody>
        </table>
    `);
}

// Функция создания заявки из справочника
function createRequestFromDirectory(terminalNumber) {
    closeModal();
    switchTab('new-request');
    
    // Заполняем номер терминала и запускаем автозаполнение
    document.querySelector('input[name="terminalNumber"]').value = terminalNumber;
    autoFillFromDatabase(terminalNumber);
}

// Функция экспорта данных
function exportVesselData(format) {
    const data = vesselDB.exportForReport(format);
    const blob = new Blob([data], { type: format === 'json' ? 'application/json' : 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vessels_${new Date().toISOString().split('T')[0]}.${format}`;
    a.click();
}
		
		const emailProcessor = new EmailProcessor();

        function initializeData() {
            if (!localStorage.getItem('ssasRequests')) {
                requests = [
                    {
                        id: 1,
                        terminalNumber: '427399999',
                        terminalType: 'INMARSAT',
                        vesselName: 'ВОЛГА-1',
                        mmsi: '273456789',
                        imo: '1234567',
                        testDate: '2025-09-06',
                        testTime: '14:30',
                        status: 'pending',
                        signalReceived: false,
                        contactPerson: 'Капитан Иванов И.И.',
                        email: 'ivanov@ship.ru',
                        phone: '+7 (999) 123-45-67'
                    },
                    {
                        id: 2,
                        terminalNumber: '427399998',
                        terminalType: 'IRIDIUM',
                        vesselName: 'НЕВА-2',
                        mmsi: '273456790',
                        testDate: '2025-09-05',
                        status: 'confirmed',
                        signalReceived: true,
                        contactPerson: 'Старпом Петров П.П.',
                        email: 'petrov@ship.ru'
                    },
                    {
                        id: 3,
                        terminalNumber: '427399997',
                        terminalType: 'INMARSAT',
                        vesselName: 'ДУНАЙ-3',
                        mmsi: '273456791',
                        testDate: '2025-09-04',
                        status: 'pending',
                        signalReceived: false,
                        contactPerson: 'Механик Сидоров С.С.',
                        email: 'sidorov@ship.ru'
                    },
                    {
                        id: 4,
                        terminalNumber: '427399996',
                        terminalType: 'IRIDIUM',
                        vesselName: 'АМУР-4',
                        mmsi: '273456792',
                        testDate: '2025-09-03',
                        status: 'confirmed',
                        signalReceived: true,
                        contactPerson: 'Капитан Козлов К.К.',
                        email: 'kozlov@ship.ru'
                    },
                    {
                        id: 5,
                        terminalNumber: '427399995',
                        terminalType: 'INMARSAT',
                        vesselName: 'ЕНИСЕЙ-5',
                        mmsi: '273456793',
                        testDate: '2025-09-02',
                        status: 'rejected',
                        signalReceived: false,
                        contactPerson: 'Боцман Морозов М.М.',
                        email: 'morozov@ship.ru'
                    }
                ];
                localStorage.setItem('ssasRequests', JSON.stringify(requests));
            } else {
                requests = JSON.parse(localStorage.getItem('ssasRequests'));
            }

            if (!localStorage.getItem('ssasSignals')) {
                signals = [
                    {
                        id: 1,
                        terminalNumber: '427399999',
                        signalType: 'TEST',
                        vesselName: 'ВОЛГА-1',
                        coordinates: { lat: 55.7558, lng: 37.6173 },
                        receivedAt: new Date().toISOString(),
                        status: 'confirmed'
                    }
                ];
                localStorage.setItem('ssasSignals', JSON.stringify(signals));
            } else {
                signals = JSON.parse(localStorage.getItem('ssasSignals'));
            }

            updateStats();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'requests') {
                loadRequests();
            } else if (tabName === 'map-container') {
                initMap();
            } else if (tabName === 'signals') {
                loadSignals();
            }
        }

        function updateStats() {
            const activeRequests = requests.filter(r => r.status === 'pending').length;
            const processedSignals = signals.length;
            const reports = parseInt(localStorage.getItem('ssasReports') || '42');
            const activeTerminals = 89;

            document.getElementById('stat-active').textContent = activeRequests;
            document.getElementById('stat-signals').textContent = processedSignals;
            document.getElementById('stat-reports').textContent = reports;
            document.getElementById('stat-terminals').textContent = activeTerminals;
        }

        function loadSignals() {
            const tbody = document.getElementById('signals-tbody');
            tbody.innerHTML = '';
            
            signals.forEach(signal => {
                const tr = document.createElement('tr');
                const time = new Date(signal.receivedAt).toLocaleTimeString('ru-RU');
                tr.innerHTML = `
                    <td>${time}</td>
                    <td>${signal.terminalNumber}</td>
                    <td><span class="status ${signal.signalType === 'TEST' ? 'success' : 'danger'}">${signal.signalType}</span></td>
                    <td>${signal.vesselName}</td>
                    <td>${signal.coordinates.lat.toFixed(4)}° N, ${signal.coordinates.lng.toFixed(4)}° E</td>
                    <td><span class="status ${signal.status}">${getStatusText(signal.status)}</span></td>
                    <td>
                        ${signal.signalType !== 'TEST' ? 
                            '<button class="danger" onclick="sendToPoiskMore()">Передать в Поиск-Море</button>' :
                            '<button onclick="viewSignalDetails()">Детали</button>'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function submitRequest(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            const existingRequest = requests.find(r => 
                r.terminalNumber === data.terminalNumber && 
                r.status === 'pending'
            );
            
            if (existingRequest) {
                showModal('Ошибка', `
                    <div class="alert danger">
                        <span>❌</span>
                        <div>
                            Заявка для терминала ${data.terminalNumber} уже существует и находится в обработке!
                        </div>
                    </div>
                `);
                return;
            }
            
            const newRequest = {
                id: Date.now(),
                ...data,
                status: 'pending',
                signalReceived: false,
                createdAt: new Date().toISOString()
            };
            
            requests.push(newRequest);
            localStorage.setItem('ssasRequests', JSON.stringify(requests));
            
            showModal('Успешно', `
                <div class="alert success">
                    <span>✅</span>
                    <div>
                        <strong>Заявка успешно создана!</strong><br>
                        Номер стойки: ${data.terminalNumber}<br>
                        Судно: ${data.vesselName}<br>
                        Дата теста: ${data.testDate}
                    </div>
                </div>
            `);
            
            event.target.reset();
            updateStats();
            
            setTimeout(() => {
                closeModal();
                switchTab('requests');
            }, 2000);
        }

        function loadRequests(filter = 'all') {
            const tbody = document.getElementById('requests-tbody');
            tbody.innerHTML = '';
            
            let filteredRequests = requests;
            if (filter !== 'all') {
                filteredRequests = requests.filter(r => r.status === filter);
            }
            
            filteredRequests.forEach(request => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${request.id}</td>
                    <td><strong>${request.terminalNumber}</strong></td>
                    <td><span class="terminal-type ${request.terminalType.toLowerCase()}">${request.terminalType}</span></td>
                    <td>${request.vesselName}</td>
                    <td>${request.mmsi}</td>
                    <td>${request.testDate} ${request.testTime || ''}</td>
                    <td><span class="status ${request.status}">${getStatusText(request.status)}</span></td>
                    <td>${request.signalReceived ? '✅' : '❌'}</td>
                    <td>
                        <button onclick="viewRequestDetails(${request.id})">Детали</button>
                        ${request.status === 'pending' ? `<button class="success" onclick="confirmRequest(${request.id})">Подтвердить</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterRequests(status) {
            loadRequests(status);
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'Ожидает',
                'confirmed': 'Подтверждено',
                'rejected': 'Отклонено',
                'processing': 'Обрабатывается'
            };
            return statusMap[status] || status;
        }

        function confirmRequest(id) {
            const request = requests.find(r => r.id === id);
            if (request) {
                request.status = 'confirmed';
                request.signalReceived = true;
                localStorage.setItem('ssasRequests', JSON.stringify(requests));
                loadRequests();
                updateStats();
                
                const signal = {
                    id: Date.now(),
                    terminalNumber: request.terminalNumber,
                    signalType: 'TEST',
                    vesselName: request.vesselName,
                    coordinates: { 
                        lat: 55.7558 + Math.random() * 10, 
                        lng: 37.6173 + Math.random() * 10 
                    },
                    receivedAt: new Date().toISOString(),
                    status: 'confirmed'
                };
                signals.push(signal);
                localStorage.setItem('ssasSignals', JSON.stringify(signals));
            }
        }

        function viewRequestDetails(id) {
            const request = requests.find(r => r.id === id);
            if (request) {
                showModal(`Заявка #${id}`, `
                    <table style="width: 100%;">
                        <tr><td><strong>Номер стойки:</strong></td><td>${request.terminalNumber}</td></tr>
                        <tr><td><strong>Тип терминала:</strong></td><td>${request.terminalType}</td></tr>
                        <tr><td><strong>Судно:</strong></td><td>${request.vesselName}</td></tr>
                        <tr><td><strong>MMSI:</strong></td><td>${request.mmsi}</td></tr>
                        <tr><td><strong>IMO:</strong></td><td>${request.imo || 'Не указан'}</td></tr>
                        <tr><td><strong>Дата теста:</strong></td><td>${request.testDate} ${request.testTime || ''}</td></tr>
                        <tr><td><strong>Контакт:</strong></td><td>${request.contactPerson}</td></tr>
                        <tr><td><strong>Email:</strong></td><td>${request.email}</td></tr>
                        <tr><td><strong>Телефон:</strong></td><td>${request.phone || 'Не указан'}</td></tr>
                        <tr><td><strong>Статус:</strong></td><td><span class="status ${request.status}">${getStatusText(request.status)}</span></td></tr>
                        ${request.source === 'email' ? '<tr><td><strong>Источник:</strong></td><td>📧 Email</td></tr>' : ''}
                    </table>
                `);
            }
        }

        function runSystemTest() {
            showModal('Тест системы', `
                <div class="alert success">
                    <span>✅</span>
                    <div>
                        <strong>Тест системы выполнен успешно!</strong><br>
                        База данных: OK<br>
                        Email сервер: OK<br>
                        API Поиск-Море: OK<br>
                        Карта: OK
                    </div>
                </div>
            `);
        }

        function sendToPoiskMore() {
            showModal('Передача в Поиск-Море', `
                <div class="alert warning">
                    <span>⚠️</span>
                    <div>
                        <strong>Реальный сигнал тревоги передан в систему Поиск-Море!</strong><br>
                        Статус: Обрабатывается дежурной сменой
                    </div>
                </div>
            `);
        }

        function showTerminalHistory(terminalNumber) {
            showModal(`История терминала ${terminalNumber}`, `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Судно</th>
                            <th>MMSI</th>
                            <th>Событие</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>06.09.2025</td>
                            <td>ВОЛГА-1</td>
                            <td>273456789</td>
                            <td>Успешный тест</td>
                        </tr>
                        <tr>
                            <td>01.08.2025</td>
                            <td>ВОЛГА-1</td>
                            <td>273456789</td>
                            <td>Установка на судно</td>
                        </tr>
                        <tr>
                            <td>30.07.2025</td>
                            <td>НЕВА-7</td>
                            <td>273456111</td>
                            <td>Демонтаж с судна</td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert info" style="margin-top: 20px;">
                    <span>ℹ️</span>
                    <div>
                        Обнаружено перемещение терминала между судами!<br>
                        Предыдущее судно: НЕВА-7 (MMSI: 273456111)<br>
                        Текущее судно: ВОЛГА-1 (MMSI: 273456789)
                    </div>
                </div>
            `);
        }

        function initMap() {
            if (map) return;
            
            map = L.map('map').setView([55.7558, 37.6173], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            signals.forEach(signal => {
                const icon = signal.signalType === 'REAL_ALERT' 
                    ? L.divIcon({className: 'alert-marker', html: '🚨'})
                    : L.divIcon({className: 'test-marker', html: '✅'});
                    
                const marker = L.marker([signal.coordinates.lat, signal.coordinates.lng], {icon})
                    .addTo(map)
                    .bindPopup(`
                        <strong>${signal.vesselName}</strong><br>
                        Терминал: ${signal.terminalNumber}<br>
                        Тип: ${signal.signalType}<br>
                        Время: ${new Date(signal.receivedAt).toLocaleString()}
                    `);
                markers.push(marker);
            });
        }

        function centerMap() {
            if (map && markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds());
            }
        }

        function generateReport() {
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;
            
            if (!startDate || !endDate) {
                showModal('Ошибка', '<div class="alert danger">Выберите период отчета!</div>');
                return;
            }
            
            const total = requests.length;
            const confirmed = requests.filter(r => r.status === 'confirmed').length;
            const pending = requests.filter(r => r.status === 'pending').length;
            const rejected = requests.filter(r => r.status === 'rejected').length;
            
            const reportHtml = `
                <div class="alert info">
                    <strong>ОТЧЕТ ПО ЗАЯВКАМ ССТО</strong><br>
                    Период: ${startDate} - ${endDate}
                </div>
                
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <h3>Всего заявок</h3>
                        <div class="value">${total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Подтверждено</h3>
                        <div class="value">${confirmed}</div>
                    </div>
                    <div class="stat-card">
                        <h3>В обработке</h3>
                        <div class="value">${pending}</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">Детализация по стойкам:</h3>
                <table style="width: 100%; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>Номер стойки</th>
                            <th>Судно</th>
                            <th>MMSI</th>
                            <th>Дата теста</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${requests.map(r => `
                            <tr>
                                <td>${r.terminalNumber}</td>
                                <td>${r.vesselName}</td>
                                <td>${r.mmsi}</td>
                                <td>${r.testDate}</td>
                                <td><span class="status ${r.status}">${getStatusText(r.status)}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('report-content').innerHTML = reportHtml;
            
            const reportsCount = parseInt(localStorage.getItem('ssasReports') || '42') + 1;
            localStorage.setItem('ssasReports', reportsCount.toString());
            updateStats();
        }

        function generateStatistics() {
            showModal('Статистика работы модуля ТЕСТ ССТО', `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Всего заявок</h3>
                        <div class="value">${requests.length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Подтверждено</h3>
                        <div class="value">${requests.filter(r => r.status === 'confirmed').length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Ожидает</h3>
                        <div class="value">${requests.filter(r => r.status === 'pending').length}</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">По типам терминалов:</h3>
                <div class="stats-grid" style="margin-top: 10px;">
                    <div class="stat-card">
                        <h3>ИНМАРСАТ</h3>
                        <div class="value">${requests.filter(r => r.terminalType === 'INMARSAT').length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>ИРИДИУМ</h3>
                        <div class="value">${requests.filter(r => r.terminalType === 'IRIDIUM').length}</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">Источники заявок:</h3>
                <div class="stats-grid" style="margin-top: 10px;">
                    <div class="stat-card">
                        <h3>Веб-форма</h3>
                        <div class="value">${requests.filter(r => !r.source || r.source === 'web').length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Email</h3>
                        <div class="value">${requests.filter(r => r.source === 'email').length}</div>
                    </div>
                </div>
            `);
        }

        function viewSignalDetails() {
            showModal('Детали сигнала', `
                <div class="alert info">
                    <span>ℹ️</span>
                    <div>
                        Тестовый сигнал успешно обработан и сопоставлен с заявкой
                    </div>
                </div>
            `);
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function exportReport() {
            showModal('Экспорт в PDF', `
                <div class="alert success">
                    <span>✅</span>
                    <div>
                        Отчет успешно экспортирован в PDF!<br>
                        Файл: SSTO_Report_${new Date().toISOString().split('T')[0]}.pdf
                    </div>
                </div>
            `);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            const now = new Date();
            document.getElementById('last-check').textContent = 
                `сегодня в ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        });

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>