<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –¢–ï–°–¢ –°–°–¢–û - –ü–æ–∏—Å–∫-–ú–æ—Ä–µ v2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: #e2e8f0;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
            color: #4a5568;
        }

        .tab:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 14px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 12px;
            opacity: 0.8;
        }

        form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group.highlight {
            grid-column: 1 / -1;
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ff6b6b;
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 14px;
        }

        .highlight label {
            color: #d32f2f;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .highlight input {
            font-size: 20px;
            font-weight: bold;
            font-family: monospace;
            background: white;
            border: 3px solid #ff6b6b;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        button.danger {
            background: linear-gradient(135deg, #f56565, #c53030);
        }

        button.success {
            background: linear-gradient(135deg, #48bb78, #2f855a);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        tr:hover {
            background: #f7fafc;
        }

        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status.confirmed {
            background: #d1fae5;
            color: #065f46;
        }

        .status.rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .close {
            font-size: 30px;
            color: #a0aec0;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #4a5568;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .terminal-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 5px;
        }

        .terminal-type.inmarsat {
            background: #e0f2fe;
            color: #0369a1;
        }

        .terminal-type.iridium {
            background: #f3e8ff;
            color: #7c3aed;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert.warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .alert.danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .email-control-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 999;
        }

        .email-control-panel h4 {
            margin: 0 0 10px 0;
            color: #2d3748;
        }

        .email-status {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            form {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <div class="logo">–°–°</div>
                –°–∏—Å—Ç–µ–º–∞ –¢–ï–°–¢ –°–°–¢–û - –ü–æ–∏—Å–∫-–ú–æ—Ä–µ
            </h1>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dashboard')">üìä –ì–ª–∞–≤–Ω–∞—è</button>
                <button class="tab" onclick="switchTab('new-request')">‚ûï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
                <button class="tab" onclick="switchTab('requests')">üìã –ó–∞—è–≤–∫–∏</button>
                <button class="tab" onclick="switchTab('signals')">üì° –°–∏–≥–Ω–∞–ª—ã</button>
                <button class="tab" onclick="switchTab('terminals')">üîß –¢–µ—Ä–º–∏–Ω–∞–ª—ã</button>
                <button class="tab" onclick="switchTab('map')">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
                <button class="tab" onclick="switchTab('reports')">üìà –û—Ç—á–µ—Ç—ã</button>
            </div>
        </header>
<!-- –ì–ª–∞–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="dashboard" class="content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏</h3>
                    <div class="value" id="stat-active">5</div>
                    <div class="change">‚Üë +2 –∑–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="stat-card">
                    <h3>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–∏–≥–Ω–∞–ª–æ–≤</h3>
                    <div class="value" id="stat-signals">127</div>
                    <div class="change">‚Üë +15 –∑–∞ –Ω–µ–¥–µ–ª—é</div>
                </div>
                <div class="stat-card">
                    <h3>–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ –æ—Ç—á–µ—Ç–æ–≤</h3>
                    <div class="value" id="stat-reports">42</div>
                    <div class="change">‚Üë +5 –∑–∞ –º–µ—Å—è—Ü</div>
                </div>
                <div class="stat-card">
                    <h3>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤</h3>
                    <div class="value" id="stat-terminals">89</div>
                    <div class="change">23 –ò–ù–ú–ê–†–°–ê–¢, 66 –ò–†–ò–î–ò–£–ú</div>
                </div>
            </div>

            <div class="alert info">
                <span>‚ÑπÔ∏è</span>
                <div>
                    <strong>–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ</strong><br>
                    –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: <span id="last-check">—Å–µ–≥–æ–¥–Ω—è –≤ 14:30</span>
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="switchTab('new-request')">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
                <button class="secondary" onclick="emailProcessor.checkEmails()">üìß –û–±—Ä–∞–±–æ—Ç–∞—Ç—å Email</button>
                <button class="success" onclick="runSystemTest()">üîß –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã</button>
                <button onclick="showVesselDirectory()">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—É–¥–æ–≤</button>
            </div>
        </div>

        <!-- –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ -->
        <div id="new-request" class="content">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –°–°–¢–û</h2>
            
            <form id="request-form" onsubmit="submitRequest(event)">
                <div class="form-group full-width highlight">
                    <label>
                        ‚ö†Ô∏è –ù–û–ú–ï–† –°–¢–û–ô–ö–ò –°–°–¢–û (–ì–õ–ê–í–ù–´–ô –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¢–û–†)
                    </label>
                    <input 
                        type="text" 
                        name="terminalNumber" 
                        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 427399999" 
                        required
                        pattern="[0-9]{9}"
                        title="9-–∑–Ω–∞—á–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞"
                        onblur="autoFillFromDatabase(this.value)"
                    >
                    <small style="color: #d32f2f; margin-top: 5px;">
                        –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –ò–ù–ú–ê–†–°–ê–¢/–ò–†–ò–î–ò–£–ú - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –∏ —Å–∏–≥–Ω–∞–ª–∞
                    </small>
                </div>

                <div class="form-group">
                    <label>–¢–∏–ø —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</label>
                    <select name="terminalType" required>
                        <option value="INMARSAT">–ò–ù–ú–ê–†–°–ê–¢</option>
                        <option value="IRIDIUM">–ò–†–ò–î–ò–£–ú</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–¥–Ω–∞</label>
                    <input type="text" name="vesselName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–û–õ–ì–ê-1" required>
                </div>

                <div class="form-group">
                    <label>MMSI</label>
                    <input type="text" name="mmsi" placeholder="273456789" pattern="[0-9]{9}" required>
                </div>

                <div class="form-group">
                    <label>IMO</label>
                    <input type="text" name="imo" placeholder="1234567" pattern="[0-9]{7}">
                </div>

                <div class="form-group">
                    <label>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞</label>
                    <input type="date" name="testDate" required>
                </div>

                <div class="form-group">
                    <label>–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="time" name="testTime">
                </div>

                <div class="form-group">
                    <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
                    <input type="text" name="contactPerson" placeholder="–ö–∞–ø–∏—Ç–∞–Ω –ò–≤–∞–Ω–æ–≤ –ò.–ò." required>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" placeholder="captain@ship.ru" required>
                </div>

                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" name="phone" placeholder="+7 (999) 123-45-67">
                </div>

                <div class="form-group full-width">
                    <label>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                    <textarea name="notes" rows="3" placeholder="–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
                </div>

                <div class="form-group full-width">
                    <button type="submit">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
                </div>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
        <div id="requests" class="content">
            <h2>–°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            
            <div class="action-buttons">
                <button onclick="filterRequests('all')">–í—Å–µ</button>
                <button class="secondary" onclick="filterRequests('pending')">–û–∂–∏–¥–∞—é—â–∏–µ</button>
                <button class="success" onclick="filterRequests('confirmed')">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ</button>
                <button class="danger" onclick="filterRequests('rejected')">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</button>
                <button onclick="showVesselDirectory()">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—É–¥–æ–≤</button>
            </div>

            <table id="requests-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏</th>
                        <th>–¢–∏–ø</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–°–∏–≥–Ω–∞–ª</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="requests-tbody">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                </tbody>
            </table>
        </div>

        <!-- –°–∏–≥–Ω–∞–ª—ã -->
        <div id="signals" class="content">
            <h2>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏–≥–Ω–∞–ª–æ–≤ –°–°–¢–û</h2>
            
            <div class="alert warning" id="real-alert" style="display: none;">
                <span>‚ö†Ô∏è</span>
                <div>
                    <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–µ–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª —Ç—Ä–µ–≤–æ–≥–∏!<br>
                    <span id="real-alert-details"></span>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–¢–µ—Ä–º–∏–Ω–∞–ª</th>
                        <th>–¢–∏–ø —Å–∏–≥–Ω–∞–ª–∞</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="signals-tbody">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                </tbody>
            </table>
        </div>

        <!-- –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ -->
        <div id="terminals" class="content">
            <h2>–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –°–°–¢–û</h2>
            
            <div class="action-buttons">
                <button onclick="showVesselDirectory()">üìö –ü–æ–ª–Ω—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—É–¥–æ–≤</button>
                <button class="secondary" onclick="checkAllTestDates()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ä–æ–∫–∏ —Ç–µ—Å—Ç–æ–≤</button>
                <button class="success" onclick="importVesselData()">üì§ –ò–º–ø–æ—Ä—Ç –∏–∑ Excel</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–ò–ù–ú–ê–†–°–ê–¢</h3>
                    <div class="value">23</div>
                    <div class="change">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤</div>
                </div>
                <div class="stat-card">
                    <h3>–ò–†–ò–î–ò–£–ú</h3>
                    <div class="value">66</div>
                    <div class="change">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤</div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>–ù–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</th>
                        <th>–¢–∏–ø</th>
                        <th>–¢–µ–∫—É—â–µ–µ —Å—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç</th>
                        <th>–ò—Å—Ç–æ—Ä–∏—è</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody id="terminals-tbody">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö -->
                </tbody>
            </table>
        </div>

        <!-- –ö–∞—Ä—Ç–∞ -->
        <div id="map-container" class="content">
            <h2>–ö–∞—Ä—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –°–°–¢–û</h2>
            <div id="map"></div>
            <div class="action-buttons">
                <button onclick="centerMap()">üéØ –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="secondary" onclick="toggleSignalTypes()">üîÑ –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–∏–ø—ã</button>
                <button class="success" onclick="exportMapData()">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            </div>
        </div>

        <!-- –û—Ç—á–µ—Ç—ã -->
        <div id="reports" class="content">
            <h2>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤</h2>
            
            <div class="form-group">
                <label>–ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="report-start">
                    <input type="date" id="report-end">
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="generateReport()">üìä –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç</button>
                <button class="secondary" onclick="generateStatistics()">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
                <button class="success" onclick="exportReport()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</button>
                <button onclick="showVesselDirectory()">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—É–¥–æ–≤</button>
            </div>

            <div id="report-content" style="margin-top: 20px;">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
            </div>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Email -->
    <div class="email-control-panel">
        <h4>üìß Email –æ–±—Ä–∞–±–æ—Ç–∫–∞</h4>
        <button onclick="emailProcessor.startAutoProcessing()" style="margin-right: 10px;">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        <button onclick="emailProcessor.stopAutoProcessing()" style="margin-right: 10px;">‚è∏Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button onclick="emailProcessor.checkEmails()">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–µ–π—á–∞—Å</button>
        <div class="email-status" id="email-status">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ</div>
    </div>
<script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        let requests = [];
        let signals = [];
        let terminals = [];
        let map = null;
        let markers = [];

        // EMAIL PROCESSING MODULE
        class EmailProcessor {
            constructor() {
                this.emailQueue = [];
                this.isProcessing = false;
                this.processInterval = null;
                this.patterns = {
                    terminal: /(?:—Ç–µ—Ä–º–∏–Ω–∞–ª|—Å—Ç–æ–π–∫–∞|terminal|–ò–ù–ú–ê–†–°–ê–¢|–ò–†–ò–î–ò–£–ú|INMARSAT|IRIDIUM)[\s:‚Ññ#]*(\d{9})/i,
                    mmsi: /MMSI[\s:]*(\d{9})/i,
                    vessel: /(?:—Å—É–¥–Ω–æ|vessel|ship)[\s:]*([–ê-–Ø–∞-—è\w\-\s]+)/i,
                    testDate: /(?:–¥–∞—Ç–∞ —Ç–µ—Å—Ç–∞|test date)[\s:]*(\d{2}[\.\/]\d{2}[\.\/]\d{4})/i,
                    signal: /(?:TEST|REAL\s*ALERT|PIRACY|DISTRESS)/i
                };
            }

            startAutoProcessing(intervalSeconds = 30) {
                if (this.processInterval) return;
                
                console.log('üìß –ó–∞–ø—É—â–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ email');
                document.getElementById('email-status').textContent = '–°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ ' + intervalSeconds + ' —Å–µ–∫)';
                
                this.processInterval = setInterval(() => {
                    this.checkEmails();
                }, intervalSeconds * 1000);
                
                this.checkEmails();
            }

            stopAutoProcessing() {
                if (this.processInterval) {
                    clearInterval(this.processInterval);
                    this.processInterval = null;
                    console.log('üìß –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ email');
                    document.getElementById('email-status').textContent = '–°—Ç–∞—Ç—É—Å: –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞';
                }
            }

            async checkEmails() {
                document.getElementById('email-status').textContent = '–°—Ç–∞—Ç—É—Å: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—á—Ç—ã...';
                
                const mockEmails = this.generateMockEmails();
                
                if (mockEmails.length > 0) {
                    console.log(`üìß –ü–æ–ª—É—á–µ–Ω–æ ${mockEmails.length} –Ω–æ–≤—ã—Ö –ø–∏—Å–µ–º`);
                    mockEmails.forEach(email => this.emailQueue.push(email));
                    this.processQueue();
                } else {
                    document.getElementById('email-status').textContent = '–°—Ç–∞—Ç—É—Å: –ù–µ—Ç –Ω–æ–≤—ã—Ö –ø–∏—Å–µ–º';
                    setTimeout(() => {
                        if (this.processInterval) {
                            document.getElementById('email-status').textContent = '–°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω–∞';
                        } else {
                            document.getElementById('email-status').textContent = '–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ';
                        }
                    }, 2000);
                }
            }

            async processQueue() {
                if (this.isProcessing || this.emailQueue.length === 0) return;
                
                this.isProcessing = true;
                document.getElementById('email-status').textContent = '–°—Ç–∞—Ç—É—Å: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∏—Å–µ–º...';
                
                const results = {
                    processed: 0,
                    created: 0,
                    rejected: 0,
                    signals: 0
                };

                while (this.emailQueue.length > 0) {
                    const email = this.emailQueue.shift();
                    const result = await this.processEmail(email);
                    
                    results.processed++;
                    if (result.type === 'request') {
                        results.created++;
                    } else if (result.type === 'signal') {
                        results.signals++;
                    } else if (result.type === 'rejected') {
                        results.rejected++;
                    }
                }

                this.isProcessing = false;
                this.showProcessingResults(results);
            }

            async processEmail(email) {
                const parsed = this.parseEmail(email);
                
                if (parsed.signalType) {
                    return this.processSignal(parsed);
                } else if (parsed.terminal) {
                    return this.processRequest(parsed);
                } else {
                    return { type: 'rejected', reason: '–ù–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' };
                }
            }

            parseEmail(email) {
                const body = email.body || '';
                const subject = email.subject || '';
                const fullText = subject + ' ' + body;
                
                const parsed = {
                    emailFrom: email.from,
                    emailDate: email.date,
                    subject: subject
                };

                const terminalMatch = fullText.match(this.patterns.terminal);
                if (terminalMatch) parsed.terminal = terminalMatch[1];

                const mmsiMatch = fullText.match(this.patterns.mmsi);
                if (mmsiMatch) parsed.mmsi = mmsiMatch[1];

                const vesselMatch = fullText.match(this.patterns.vessel);
                if (vesselMatch) parsed.vessel = vesselMatch[1].trim();

                const dateMatch = fullText.match(this.patterns.testDate);
                if (dateMatch) {
                    const [day, month, year] = dateMatch[1].split(/[\.\/]/);
                    parsed.testDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }

                const signalMatch = fullText.match(this.patterns.signal);
                if (signalMatch) parsed.signalType = signalMatch[0];

                if (/–ò–†–ò–î–ò–£–ú|IRIDIUM/i.test(fullText)) {
                    parsed.terminalType = 'IRIDIUM';
                } else {
                    parsed.terminalType = 'INMARSAT';
                }

                return parsed;
            }

            processSignal(data) {
                const signal = {
                    id: Date.now(),
                    terminalNumber: data.terminal,
                    signalType: data.signalType,
                    vesselName: data.vessel || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    mmsi: data.mmsi,
                    coordinates: {
                        lat: 55.7558 + Math.random() * 10,
                        lng: 37.6173 + Math.random() * 10
                    },
                    receivedAt: new Date().toISOString(),
                    status: data.signalType === 'TEST' ? 'confirmed' : 'processing'
                };

                signals.push(signal);
                localStorage.setItem('ssasSignals', JSON.stringify(signals));

                if (data.signalType !== 'TEST') {
                    this.handleRealAlert(signal);
                }

                this.matchSignalToRequest(signal);

                updateStats();
                loadSignals();

                return { type: 'signal', data: signal };
            }

            processRequest(data) {
                if (!data.terminal || !data.vessel) {
                    return { type: 'rejected', reason: '–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è' };
                }

                const newRequest = {
                    id: Date.now(),
                    terminalNumber: data.terminal,
                    terminalType: data.terminalType || 'INMARSAT',
                    vesselName: data.vessel,
                    mmsi: data.mmsi || '',
                    testDate: data.testDate || new Date().toISOString().split('T')[0],
                    status: 'pending',
                    signalReceived: false,
                    contactPerson: data.emailFrom.split('@')[0],
                    email: data.emailFrom,
                    source: 'email',
                    createdAt: new Date().toISOString()
                };

                requests.push(newRequest);
                localStorage.setItem('ssasRequests', JSON.stringify(requests));

                updateStats();
                if (document.getElementById('requests').classList.contains('active')) {
                    loadRequests();
                }

                return { type: 'request', data: newRequest };
            }

            matchSignalToRequest(signal) {
                const matchingRequest = requests.find(r => 
                    r.terminalNumber === signal.terminalNumber && 
                    r.status === 'pending'
                );

                if (matchingRequest) {
                    matchingRequest.status = 'confirmed';
                    matchingRequest.signalReceived = true;
                    localStorage.setItem('ssasRequests', JSON.stringify(requests));
                    console.log(`‚úÖ –°–∏–≥–Ω–∞–ª —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω —Å –∑–∞—è–≤–∫–æ–π #${matchingRequest.id}`);
                }
            }

            handleRealAlert(signal) {
                console.error('üö® –†–ï–ê–õ–¨–ù–ê–Ø –¢–†–ï–í–û–ì–ê!', signal);
                
                const alertDiv = document.getElementById('real-alert');
                const alertDetails = document.getElementById('real-alert-details');
                alertDetails.textContent = `–¢–µ—Ä–º–∏–Ω–∞–ª: ${signal.terminalNumber}, –°—É–¥–Ω–æ: ${signal.vesselName}, –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${signal.coordinates.lat.toFixed(4)}¬∞ N, ${signal.coordinates.lng.toFixed(4)}¬∞ E`;
                alertDiv.style.display = 'flex';
                
                this.sendToPoiskMore(signal);
            }

            sendToPoiskMore(signal) {
                console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –ü–æ–∏—Å–∫-–ú–æ—Ä–µ:', signal);
                
                showModal('–ü–µ—Ä–µ–¥–∞—á–∞ –≤ –ü–æ–∏—Å–∫-–ú–æ—Ä–µ', `
                    <div class="alert warning">
                        <span>‚ö†Ô∏è</span>
                        <div>
                            <strong>–†–µ–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª —Ç—Ä–µ–≤–æ–≥–∏ –ø–µ—Ä–µ–¥–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É –ü–æ–∏—Å–∫-–ú–æ—Ä–µ!</strong><br>
                            –¢–µ—Ä–º–∏–Ω–∞–ª: ${signal.terminalNumber}<br>
                            –°—É–¥–Ω–æ: ${signal.vesselName}<br>
                            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${signal.coordinates.lat.toFixed(4)}¬∞ N, ${signal.coordinates.lng.toFixed(4)}¬∞ E<br>
                            –°—Ç–∞—Ç—É—Å: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–µ–∂—É—Ä–Ω–æ–π —Å–º–µ–Ω–æ–π
                        </div>
                    </div>
                `);
            }

            generateMockEmails() {
                const chance = Math.random();
                if (chance > 0.7) {
                    return [{
                        from: `captain${Math.floor(Math.random() * 100)}@ship.ru`,
                        subject: '–ó–∞—è–≤–∫–∞ –Ω–∞ —Ç–µ—Å—Ç –°–°–¢–û',
                        body: `–ü—Ä–æ—à—É –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –°–°–¢–û.
                               –¢–µ—Ä–º–∏–Ω–∞–ª: ${427300000 + Math.floor(Math.random() * 100000)}
                               –°—É–¥–Ω–æ: –¢–ï–°–¢-${Math.floor(Math.random() * 100)}
                               MMSI: ${273000000 + Math.floor(Math.random() * 100000)}
                               –¢–∏–ø: ${Math.random() > 0.5 ? '–ò–ù–ú–ê–†–°–ê–¢' : '–ò–†–ò–î–ò–£–ú'}
                               –î–∞—Ç–∞ —Ç–µ—Å—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}`,
                        date: new Date().toISOString()
                    }];
                } else if (chance > 0.5) {
                    return [{
                        from: 'ssas@terminal.com',
                        subject: 'SSAS TEST SIGNAL',
                        body: `TEST
                               Terminal: ${427300000 + Math.floor(Math.random() * 100000)}
                               Vessel: –°–ò–ì–ù–ê–õ-${Math.floor(Math.random() * 100)}
                               MMSI: ${273000000 + Math.floor(Math.random() * 100000)}
                               Position: ${(55 + Math.random() * 10).toFixed(4)}N ${(37 + Math.random() * 10).toFixed(4)}E`,
                        date: new Date().toISOString()
                    }];
                } else if (chance > 0.45) {
                    return [{
                        from: 'ssas@terminal.com',
                        subject: 'SSAS REAL ALERT',
                        body: `REAL ALERT - PIRACY
                               Terminal: ${427399888}
                               Vessel: –¢–†–ï–í–û–ì–ê-${Math.floor(Math.random() * 10)}
                               MMSI: ${273999888}
                               Position: ${(59 + Math.random() * 2).toFixed(4)}N ${(30 + Math.random() * 2).toFixed(4)}E`,
                        date: new Date().toISOString()
                    }];
                }
                return [];
            }

            showProcessingResults(results) {
                if (results.processed > 0) {
                    const message = `
                        üìß –û–±—Ä–∞–±–æ—Ç–∫–∞ email –∑–∞–≤–µ—Ä—à–µ–Ω–∞:
                        ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–∏—Å–µ–º: ${results.processed}
                        ‚Ä¢ –°–æ–∑–¥–∞–Ω–æ –∑–∞—è–≤–æ–∫: ${results.created}
                        ‚Ä¢ –ü–æ–ª—É—á–µ–Ω–æ —Å–∏–≥–Ω–∞–ª–æ–≤: ${results.signals}
                        ‚Ä¢ –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: ${results.rejected}
                    `;
                    console.log(message);
                    
                    showModal('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ Email', `
                        <div class="alert ${results.created > 0 || results.signals > 0 ? 'success' : 'info'}">
                            <span>${results.created > 0 || results.signals > 0 ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
                            <div>
                                <strong>–û–±—Ä–∞–±–æ—Ç–∫–∞ email –∑–∞–≤–µ—Ä—à–µ–Ω–∞</strong><br>
                                –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–∏—Å–µ–º: ${results.processed}<br>
                                –°–æ–∑–¥–∞–Ω–æ –∑–∞—è–≤–æ–∫: ${results.created}<br>
                                –ü–æ–ª—É—á–µ–Ω–æ —Å–∏–≥–Ω–∞–ª–æ–≤: ${results.signals}<br>
                                –û—Ç–∫–ª–æ–Ω–µ–Ω–æ: ${results.rejected}
                            </div>
                        </div>
                    `);
                    
                    updateStats();
                    if (document.getElementById('requests').classList.contains('active')) {
                        loadRequests();
                    }
                    
                    document.getElementById('email-status').textContent = this.processInterval ? '–°—Ç–∞—Ç—É—Å: –ê–∫—Ç–∏–≤–Ω–∞' : '–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ';
                }
            }
        }

        // –°–ü–†–ê–í–û–ß–ù–´–ô –ú–û–î–£–õ–¨ –î–ê–ù–ù–´–• –û –°–£–î–ê–• –ò –í–õ–ê–î–ï–õ–¨–¶–ê–•
class VesselDatabase {
    constructor() {
        // –î–∞–Ω–Ω—ã–µ –∏–∑ Excel —Ñ–∞–π–ª–∞ (–ø—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∏—á–Ω–æ–≥–æ –∂—É—Ä–Ω–∞–ª–∞ –°–°–¢–û)
        this.vessels = [
            {
                imo: '9234567',
                mmsi: '273456789',
                vesselName: '–í–û–õ–ì–ê-1',
                owner: '–û–û–û "–í–æ–ª–∂—Å–∫–æ–µ –ø–∞—Ä–æ—Ö–æ–¥—Å—Ç–≤–æ"',
                terminalNumber: '427399999',
                terminalType: 'INMARSAT',
                responsiblePerson: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á',
                email: 'ivanov@volga-ship.ru',
                phone: '+7 (846) 123-45-67',
                lastTestDate: '2024-09-06',
                testHistory: [
                    { date: '2024-09-06', status: 'success', signal: 'received' },
                    { date: '2023-09-05', status: 'success', signal: 'received' },
                    { date: '2022-09-04', status: 'success', signal: 'received' }
                ]
            },
            {
                imo: '9234568',
                mmsi: '273456790',
                vesselName: '–ù–ï–í–ê-2',
                owner: '–ê–û "–°–µ–≤–µ—Ä–Ω–æ–µ —Ä–µ—á–Ω–æ–µ –ø–∞—Ä–æ—Ö–æ–¥—Å—Ç–≤–æ"',
                terminalNumber: '427399998',
                terminalType: 'IRIDIUM',
                responsiblePerson: '–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á',
                email: 'petrov@neva-ship.ru',
                phone: '+7 (812) 234-56-78',
                lastTestDate: '2024-09-05',
                testHistory: [
                    { date: '2024-09-05', status: 'success', signal: 'received' },
                    { date: '2023-09-06', status: 'success', signal: 'received' }
                ]
            },
            {
                imo: '9234569',
                mmsi: '273456791',
                vesselName: '–î–£–ù–ê–ô-3',
                owner: '–û–û–û "–î—É–Ω–∞–π—Å–∫–æ–µ –ø–∞—Ä–æ—Ö–æ–¥—Å—Ç–≤–æ"',
                terminalNumber: '427399997',
                terminalType: 'INMARSAT',
                responsiblePerson: '–°–∏–¥–æ—Ä–æ–≤ –°–∏–¥–æ—Ä –°–∏–¥–æ—Ä–æ–≤–∏—á',
                email: 'sidorov@dunay.ru',
                phone: '+7 (863) 345-67-89',
                lastTestDate: '2024-09-04',
                testHistory: [
                    { date: '2024-09-04', status: 'pending', signal: 'not_received' }
                ]
            }
        ];

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –µ—Å–ª–∏ –µ—Å—Ç—å
        const storedVessels = localStorage.getItem('vesselDatabase');
        if (storedVessels) {
            this.vessels = JSON.parse(storedVessels);
        } else {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            localStorage.setItem('vesselDatabase', JSON.stringify(this.vessels));
        }
    }

    // –ü–æ–∏—Å–∫ —Å—É–¥–Ω–∞ –ø–æ —Ä–∞–∑–ª–∏—á–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
    findVessel(searchParam, searchType = 'auto') {
        if (searchType === 'auto') {
            // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
            if (/^\d{7}$/.test(searchParam)) {
                searchType = 'imo';
            } else if (/^\d{9}$/.test(searchParam)) {
                // –ú–æ–∂–µ—Ç –±—ã—Ç—å MMSI –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
                const byMMSI = this.vessels.find(v => v.mmsi === searchParam);
                const byTerminal = this.vessels.find(v => v.terminalNumber === searchParam);
                return byMMSI || byTerminal || null;
            } else {
                searchType = 'name';
            }
        }

        switch(searchType) {
            case 'imo':
                return this.vessels.find(v => v.imo === searchParam);
            case 'mmsi':
                return this.vessels.find(v => v.mmsi === searchParam);
            case 'terminal':
                return this.vessels.find(v => v.terminalNumber === searchParam);
            case 'name':
                return this.vessels.find(v => 
                    v.vesselName.toLowerCase().includes(searchParam.toLowerCase())
                );
            default:
                return null;
        }
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤ —Å—É–¥–Ω–∞
    getTestHistory(terminalNumber) {
        const vessel = this.findVessel(terminalNumber, 'terminal');
        return vessel ? vessel.testHistory : [];
    }

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—É–¥–Ω–∞
    addVessel(vesselData) {
        this.vessels.push(vesselData);
        localStorage.setItem('vesselDatabase', JSON.stringify(this.vessels));
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—É–¥–Ω–∞
    updateVessel(terminalNumber, updateData) {
        const index = this.vessels.findIndex(v => v.terminalNumber === terminalNumber);
        if (index !== -1) {
            this.vessels[index] = { ...this.vessels[index], ...updateData };
            localStorage.setItem('vesselDatabase', JSON.stringify(this.vessels));
            return true;
        }
        return false;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—É–¥–æ–≤
    getAllVessels() {
        return this.vessels;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ç–µ—Å—Ç–∞
    checkTestDue(terminalNumber) {
        const vessel = this.findVessel(terminalNumber, 'terminal');
        if (!vessel || !vessel.lastTestDate) return true;

        const lastTest = new Date(vessel.lastTestDate);
        const now = new Date();
        const monthsSinceLastTest = (now - lastTest) / (1000 * 60 * 60 * 24 * 30);
        
        return monthsSinceLastTest >= 11; // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ –º–µ—Å—è—Ü –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≥–æ–¥–∞
    }

    // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
    exportForReport(format = 'json') {
        if (format === 'json') {
            return JSON.stringify(this.vessels, null, 2);
        } else if (format === 'csv') {
            const headers = 'IMO,MMSI,–ù–∞–∑–≤–∞–Ω–∏–µ,–í–ª–∞–¥–µ–ª–µ—Ü,–¢–µ—Ä–º–∏–Ω–∞–ª,–¢–∏–ø,–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π,Email,–¢–µ–ª–µ—Ñ–æ–Ω,–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç\n';
            const rows = this.vessels.map(v => 
                `${v.imo},${v.mmsi},${v.vesselName},${v.owner},${v.terminalNumber},${v.terminalType},${v.responsiblePerson},${v.email},${v.phone},${v.lastTestDate}`
            ).join('\n');
            return headers + rows;
        }
    }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å—É–¥–æ–≤
const vesselDB = new VesselDatabase();

// –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–∏ –≤–≤–æ–¥–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
function autoFillFromDatabase(terminalNumber) {
    const vessel = vesselDB.findVessel(terminalNumber, 'terminal');
    if (vessel) {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã
        document.querySelector('input[name="vesselName"]').value = vessel.vesselName;
        document.querySelector('input[name="mmsi"]').value = vessel.mmsi;
        document.querySelector('input[name="imo"]').value = vessel.imo;
        document.querySelector('select[name="terminalType"]').value = vessel.terminalType;
        document.querySelector('input[name="contactPerson"]').value = vessel.responsiblePerson;
        document.querySelector('input[name="email"]').value = vessel.email;
        document.querySelector('input[name="phone"]').value = vessel.phone;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ
        showModal('–î–∞–Ω–Ω—ã–µ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞', `
            <div class="alert info">
                <span>‚ÑπÔ∏è</span>
                <div>
                    <strong>–°—É–¥–Ω–æ –Ω–∞–π–¥–µ–Ω–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö!</strong><br>
                    –í–ª–∞–¥–µ–ª–µ—Ü: ${vessel.owner}<br>
                    –ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç: ${vessel.lastTestDate}<br>
                    ${vesselDB.checkTestDue(terminalNumber) ? 
                        '<span style="color: red;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –≥–æ–¥–æ–≤–æ–≥–æ —Ç–µ—Å—Ç–∞!</span>' : 
                        '<span style="color: green;">‚úÖ –ì–æ–¥–æ–≤–æ–π —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω –≤–æ–≤—Ä–µ–º—è</span>'}
                </div>
            </div>
        `);
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—É–¥–æ–≤
function showVesselDirectory() {
    const vessels = vesselDB.getAllVessels();
    const tableRows = vessels.map(v => `
        <tr>
            <td>${v.imo}</td>
            <td>${v.mmsi}</td>
            <td><strong>${v.vesselName}</strong></td>
            <td>${v.owner}</td>
            <td><strong>${v.terminalNumber}</strong></td>
            <td><span class="terminal-type ${v.terminalType.toLowerCase()}">${v.terminalType}</span></td>
            <td>${v.responsiblePerson}</td>
            <td>${v.email}</td>
            <td>${v.phone}</td>
            <td>${v.lastTestDate}</td>
            <td>
                ${vesselDB.checkTestDue(v.terminalNumber) ? 
                    '<span class="status rejected">–¢—Ä–µ–±—É–µ—Ç—Å—è</span>' : 
                    '<span class="status confirmed">–í —Å—Ä–æ–∫</span>'}
            </td>
            <td>
                <button onclick="viewVesselHistory('${v.terminalNumber}')">–ò—Å—Ç–æ—Ä–∏—è</button>
                <button onclick="createRequestFromDirectory('${v.terminalNumber}')">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
            </td>
        </tr>
    `).join('');

    showModal('–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å—É–¥–æ–≤ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤', `
        <div style="max-width: 100%; overflow-x: auto;">
            <table style="width: 100%; font-size: 12px;">
                <thead>
                    <tr>
                        <th>IMO</th>
                        <th>MMSI</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                        <th>–¢–µ—Ä–º–∏–Ω–∞–ª</th>
                        <th>–¢–∏–ø</th>
                        <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                        <th>Email</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
        <div class="action-buttons" style="margin-top: 20px;">
            <button onclick="exportVesselData('json')">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button onclick="exportVesselData('csv')">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
            <button onclick="importVesselData()">üì§ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
        </div>
    `);
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å—É–¥–Ω–∞
function viewVesselHistory(terminalNumber) {
    const vessel = vesselDB.findVessel(terminalNumber, 'terminal');
    if (!vessel) return;

    const historyRows = vessel.testHistory.map(h => `
        <tr>
            <td>${h.date}</td>
            <td><span class="status ${h.status === 'success' ? 'confirmed' : 'pending'}">${h.status}</span></td>
            <td>${h.signal === 'received' ? '‚úÖ –ü–æ–ª—É—á–µ–Ω' : '‚ùå –ù–µ –ø–æ–ª—É—á–µ–Ω'}</td>
        </tr>
    `).join('');

    showModal(`–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤: ${vessel.vesselName}`, `
        <div class="alert info">
            <strong>–°—É–¥–Ω–æ:</strong> ${vessel.vesselName}<br>
            <strong>IMO:</strong> ${vessel.imo}<br>
            <strong>MMSI:</strong> ${vessel.mmsi}<br>
            <strong>–í–ª–∞–¥–µ–ª–µ—Ü:</strong> ${vessel.owner}<br>
            <strong>–¢–µ—Ä–º–∏–Ω–∞–ª:</strong> ${vessel.terminalNumber}
        </div>
        
        <h3 style="margin-top: 20px;">–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–π:</h3>
        <table style="width: 100%; margin-top: 10px;">
            <thead>
                <tr>
                    <th>–î–∞—Ç–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–°–∏–≥–Ω–∞–ª</th>
                </tr>
            </thead>
            <tbody>
                ${historyRows}
            </tbody>
        </table>
    `);
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
function createRequestFromDirectory(terminalNumber) {
    closeModal();
    switchTab('new-request');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
    document.querySelector('input[name="terminalNumber"]').value = terminalNumber;
    autoFillFromDatabase(terminalNumber);
}

// –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
function exportVesselData(format) {
    const data = vesselDB.exportForReport(format);
    const blob = new Blob([data], { type: format === 'json' ? 'application/json' : 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `vessels_${new Date().toISOString().split('T')[0]}.${format}`;
    a.click();
}
		
		const emailProcessor = new EmailProcessor();

        function initializeData() {
            if (!localStorage.getItem('ssasRequests')) {
                requests = [
                    {
                        id: 1,
                        terminalNumber: '427399999',
                        terminalType: 'INMARSAT',
                        vesselName: '–í–û–õ–ì–ê-1',
                        mmsi: '273456789',
                        imo: '1234567',
                        testDate: '2025-09-06',
                        testTime: '14:30',
                        status: 'pending',
                        signalReceived: false,
                        contactPerson: '–ö–∞–ø–∏—Ç–∞–Ω –ò–≤–∞–Ω–æ–≤ –ò.–ò.',
                        email: 'ivanov@ship.ru',
                        phone: '+7 (999) 123-45-67'
                    },
                    {
                        id: 2,
                        terminalNumber: '427399998',
                        terminalType: 'IRIDIUM',
                        vesselName: '–ù–ï–í–ê-2',
                        mmsi: '273456790',
                        testDate: '2025-09-05',
                        status: 'confirmed',
                        signalReceived: true,
                        contactPerson: '–°—Ç–∞—Ä–ø–æ–º –ü–µ—Ç—Ä–æ–≤ –ü.–ü.',
                        email: 'petrov@ship.ru'
                    },
                    {
                        id: 3,
                        terminalNumber: '427399997',
                        terminalType: 'INMARSAT',
                        vesselName: '–î–£–ù–ê–ô-3',
                        mmsi: '273456791',
                        testDate: '2025-09-04',
                        status: 'pending',
                        signalReceived: false,
                        contactPerson: '–ú–µ—Ö–∞–Ω–∏–∫ –°–∏–¥–æ—Ä–æ–≤ –°.–°.',
                        email: 'sidorov@ship.ru'
                    },
                    {
                        id: 4,
                        terminalNumber: '427399996',
                        terminalType: 'IRIDIUM',
                        vesselName: '–ê–ú–£–†-4',
                        mmsi: '273456792',
                        testDate: '2025-09-03',
                        status: 'confirmed',
                        signalReceived: true,
                        contactPerson: '–ö–∞–ø–∏—Ç–∞–Ω –ö–æ–∑–ª–æ–≤ –ö.–ö.',
                        email: 'kozlov@ship.ru'
                    },
                    {
                        id: 5,
                        terminalNumber: '427399995',
                        terminalType: 'INMARSAT',
                        vesselName: '–ï–ù–ò–°–ï–ô-5',
                        mmsi: '273456793',
                        testDate: '2025-09-02',
                        status: 'rejected',
                        signalReceived: false,
                        contactPerson: '–ë–æ—Ü–º–∞–Ω –ú–æ—Ä–æ–∑–æ–≤ –ú.–ú.',
                        email: 'morozov@ship.ru'
                    }
                ];
                localStorage.setItem('ssasRequests', JSON.stringify(requests));
            } else {
                requests = JSON.parse(localStorage.getItem('ssasRequests'));
            }

            if (!localStorage.getItem('ssasSignals')) {
                signals = [
                    {
                        id: 1,
                        terminalNumber: '427399999',
                        signalType: 'TEST',
                        vesselName: '–í–û–õ–ì–ê-1',
                        coordinates: { lat: 55.7558, lng: 37.6173 },
                        receivedAt: new Date().toISOString(),
                        status: 'confirmed'
                    }
                ];
                localStorage.setItem('ssasSignals', JSON.stringify(signals));
            } else {
                signals = JSON.parse(localStorage.getItem('ssasSignals'));
            }

            updateStats();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'requests') {
                loadRequests();
            } else if (tabName === 'map-container') {
                initMap();
            } else if (tabName === 'signals') {
                loadSignals();
            }
        }

        function updateStats() {
            const activeRequests = requests.filter(r => r.status === 'pending').length;
            const processedSignals = signals.length;
            const reports = parseInt(localStorage.getItem('ssasReports') || '42');
            const activeTerminals = 89;

            document.getElementById('stat-active').textContent = activeRequests;
            document.getElementById('stat-signals').textContent = processedSignals;
            document.getElementById('stat-reports').textContent = reports;
            document.getElementById('stat-terminals').textContent = activeTerminals;
        }

        function loadSignals() {
            const tbody = document.getElementById('signals-tbody');
            tbody.innerHTML = '';
            
            signals.forEach(signal => {
                const tr = document.createElement('tr');
                const time = new Date(signal.receivedAt).toLocaleTimeString('ru-RU');
                tr.innerHTML = `
                    <td>${time}</td>
                    <td>${signal.terminalNumber}</td>
                    <td><span class="status ${signal.signalType === 'TEST' ? 'success' : 'danger'}">${signal.signalType}</span></td>
                    <td>${signal.vesselName}</td>
                    <td>${signal.coordinates.lat.toFixed(4)}¬∞ N, ${signal.coordinates.lng.toFixed(4)}¬∞ E</td>
                    <td><span class="status ${signal.status}">${getStatusText(signal.status)}</span></td>
                    <td>
                        ${signal.signalType !== 'TEST' ? 
                            '<button class="danger" onclick="sendToPoiskMore()">–ü–µ—Ä–µ–¥–∞—Ç—å –≤ –ü–æ–∏—Å–∫-–ú–æ—Ä–µ</button>' :
                            '<button onclick="viewSignalDetails()">–î–µ—Ç–∞–ª–∏</button>'
                        }
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function submitRequest(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            const existingRequest = requests.find(r => 
                r.terminalNumber === data.terminalNumber && 
                r.status === 'pending'
            );
            
            if (existingRequest) {
                showModal('–û—à–∏–±–∫–∞', `
                    <div class="alert danger">
                        <span>‚ùå</span>
                        <div>
                            –ó–∞—è–≤–∫–∞ –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ${data.terminalNumber} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ!
                        </div>
                    </div>
                `);
                return;
            }
            
            const newRequest = {
                id: Date.now(),
                ...data,
                status: 'pending',
                signalReceived: false,
                createdAt: new Date().toISOString()
            };
            
            requests.push(newRequest);
            localStorage.setItem('ssasRequests', JSON.stringify(requests));
            
            showModal('–£—Å–ø–µ—à–Ω–æ', `
                <div class="alert success">
                    <span>‚úÖ</span>
                    <div>
                        <strong>–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!</strong><br>
                        –ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏: ${data.terminalNumber}<br>
                        –°—É–¥–Ω–æ: ${data.vesselName}<br>
                        –î–∞—Ç–∞ —Ç–µ—Å—Ç–∞: ${data.testDate}
                    </div>
                </div>
            `);
            
            event.target.reset();
            updateStats();
            
            setTimeout(() => {
                closeModal();
                switchTab('requests');
            }, 2000);
        }

        function loadRequests(filter = 'all') {
            const tbody = document.getElementById('requests-tbody');
            tbody.innerHTML = '';
            
            let filteredRequests = requests;
            if (filter !== 'all') {
                filteredRequests = requests.filter(r => r.status === filter);
            }
            
            filteredRequests.forEach(request => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${request.id}</td>
                    <td><strong>${request.terminalNumber}</strong></td>
                    <td><span class="terminal-type ${request.terminalType.toLowerCase()}">${request.terminalType}</span></td>
                    <td>${request.vesselName}</td>
                    <td>${request.mmsi}</td>
                    <td>${request.testDate} ${request.testTime || ''}</td>
                    <td><span class="status ${request.status}">${getStatusText(request.status)}</span></td>
                    <td>${request.signalReceived ? '‚úÖ' : '‚ùå'}</td>
                    <td>
                        <button onclick="viewRequestDetails(${request.id})">–î–µ—Ç–∞–ª–∏</button>
                        ${request.status === 'pending' ? `<button class="success" onclick="confirmRequest(${request.id})">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filterRequests(status) {
            loadRequests(status);
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '–û–∂–∏–¥–∞–µ—Ç',
                'confirmed': '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ',
                'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
                'processing': '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è'
            };
            return statusMap[status] || status;
        }

        function confirmRequest(id) {
            const request = requests.find(r => r.id === id);
            if (request) {
                request.status = 'confirmed';
                request.signalReceived = true;
                localStorage.setItem('ssasRequests', JSON.stringify(requests));
                loadRequests();
                updateStats();
                
                const signal = {
                    id: Date.now(),
                    terminalNumber: request.terminalNumber,
                    signalType: 'TEST',
                    vesselName: request.vesselName,
                    coordinates: { 
                        lat: 55.7558 + Math.random() * 10, 
                        lng: 37.6173 + Math.random() * 10 
                    },
                    receivedAt: new Date().toISOString(),
                    status: 'confirmed'
                };
                signals.push(signal);
                localStorage.setItem('ssasSignals', JSON.stringify(signals));
            }
        }

        function viewRequestDetails(id) {
            const request = requests.find(r => r.id === id);
            if (request) {
                showModal(`–ó–∞—è–≤–∫–∞ #${id}`, `
                    <table style="width: 100%;">
                        <tr><td><strong>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏:</strong></td><td>${request.terminalNumber}</td></tr>
                        <tr><td><strong>–¢–∏–ø —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:</strong></td><td>${request.terminalType}</td></tr>
                        <tr><td><strong>–°—É–¥–Ω–æ:</strong></td><td>${request.vesselName}</td></tr>
                        <tr><td><strong>MMSI:</strong></td><td>${request.mmsi}</td></tr>
                        <tr><td><strong>IMO:</strong></td><td>${request.imo || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td></tr>
                        <tr><td><strong>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞:</strong></td><td>${request.testDate} ${request.testTime || ''}</td></tr>
                        <tr><td><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong></td><td>${request.contactPerson}</td></tr>
                        <tr><td><strong>Email:</strong></td><td>${request.email}</td></tr>
                        <tr><td><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></td><td>${request.phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td></tr>
                        <tr><td><strong>–°—Ç–∞—Ç—É—Å:</strong></td><td><span class="status ${request.status}">${getStatusText(request.status)}</span></td></tr>
                        ${request.source === 'email' ? '<tr><td><strong>–ò—Å—Ç–æ—á–Ω–∏–∫:</strong></td><td>üìß Email</td></tr>' : ''}
                    </table>
                `);
            }
        }

        function runSystemTest() {
            showModal('–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã', `
                <div class="alert success">
                    <span>‚úÖ</span>
                    <div>
                        <strong>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!</strong><br>
                        –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: OK<br>
                        Email —Å–µ—Ä–≤–µ—Ä: OK<br>
                        API –ü–æ–∏—Å–∫-–ú–æ—Ä–µ: OK<br>
                        –ö–∞—Ä—Ç–∞: OK
                    </div>
                </div>
            `);
        }

        function sendToPoiskMore() {
            showModal('–ü–µ—Ä–µ–¥–∞—á–∞ –≤ –ü–æ–∏—Å–∫-–ú–æ—Ä–µ', `
                <div class="alert warning">
                    <span>‚ö†Ô∏è</span>
                    <div>
                        <strong>–†–µ–∞–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª —Ç—Ä–µ–≤–æ–≥–∏ –ø–µ—Ä–µ–¥–∞–Ω –≤ —Å–∏—Å—Ç–µ–º—É –ü–æ–∏—Å–∫-–ú–æ—Ä–µ!</strong><br>
                        –°—Ç–∞—Ç—É—Å: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –¥–µ–∂—É—Ä–Ω–æ–π —Å–º–µ–Ω–æ–π
                    </div>
                </div>
            `);
        }

        function showTerminalHistory(terminalNumber) {
            showModal(`–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ${terminalNumber}`, `
                <table style="width: 100%;">
                    <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—É–¥–Ω–æ</th>
                            <th>MMSI</th>
                            <th>–°–æ–±—ã—Ç–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>06.09.2025</td>
                            <td>–í–û–õ–ì–ê-1</td>
                            <td>273456789</td>
                            <td>–£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç</td>
                        </tr>
                        <tr>
                            <td>01.08.2025</td>
                            <td>–í–û–õ–ì–ê-1</td>
                            <td>273456789</td>
                            <td>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å—É–¥–Ω–æ</td>
                        </tr>
                        <tr>
                            <td>30.07.2025</td>
                            <td>–ù–ï–í–ê-7</td>
                            <td>273456111</td>
                            <td>–î–µ–º–æ–Ω—Ç–∞–∂ —Å —Å—É–¥–Ω–∞</td>
                        </tr>
                    </tbody>
                </table>
                <div class="alert info" style="margin-top: 20px;">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –º–µ–∂–¥—É —Å—É–¥–∞–º–∏!<br>
                        –ü—Ä–µ–¥—ã–¥—É—â–µ–µ —Å—É–¥–Ω–æ: –ù–ï–í–ê-7 (MMSI: 273456111)<br>
                        –¢–µ–∫—É—â–µ–µ —Å—É–¥–Ω–æ: –í–û–õ–ì–ê-1 (MMSI: 273456789)
                    </div>
                </div>
            `);
        }

        function initMap() {
            if (map) return;
            
            map = L.map('map').setView([55.7558, 37.6173], 5);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            signals.forEach(signal => {
                const icon = signal.signalType === 'REAL_ALERT' 
                    ? L.divIcon({className: 'alert-marker', html: 'üö®'})
                    : L.divIcon({className: 'test-marker', html: '‚úÖ'});
                    
                const marker = L.marker([signal.coordinates.lat, signal.coordinates.lng], {icon})
                    .addTo(map)
                    .bindPopup(`
                        <strong>${signal.vesselName}</strong><br>
                        –¢–µ—Ä–º–∏–Ω–∞–ª: ${signal.terminalNumber}<br>
                        –¢–∏–ø: ${signal.signalType}<br>
                        –í—Ä–µ–º—è: ${new Date(signal.receivedAt).toLocaleString()}
                    `);
                markers.push(marker);
            });
        }

        function centerMap() {
            if (map && markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds());
            }
        }

        function generateReport() {
            const startDate = document.getElementById('report-start').value;
            const endDate = document.getElementById('report-end').value;
            
            if (!startDate || !endDate) {
                showModal('–û—à–∏–±–∫–∞', '<div class="alert danger">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–∞!</div>');
                return;
            }
            
            const total = requests.length;
            const confirmed = requests.filter(r => r.status === 'confirmed').length;
            const pending = requests.filter(r => r.status === 'pending').length;
            const rejected = requests.filter(r => r.status === 'rejected').length;
            
            const reportHtml = `
                <div class="alert info">
                    <strong>–û–¢–ß–ï–¢ –ü–û –ó–ê–Ø–í–ö–ê–ú –°–°–¢–û</strong><br>
                    –ü–µ—Ä–∏–æ–¥: ${startDate} - ${endDate}
                </div>
                
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</h3>
                        <div class="value">${total}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</h3>
                        <div class="value">${confirmed}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</h3>
                        <div class="value">${pending}</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Å—Ç–æ–π–∫–∞–º:</h3>
                <table style="width: 100%; margin-top: 10px;">
                    <thead>
                        <tr>
                            <th>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏</th>
                            <th>–°—É–¥–Ω–æ</th>
                            <th>MMSI</th>
                            <th>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${requests.map(r => `
                            <tr>
                                <td>${r.terminalNumber}</td>
                                <td>${r.vesselName}</td>
                                <td>${r.mmsi}</td>
                                <td>${r.testDate}</td>
                                <td><span class="status ${r.status}">${getStatusText(r.status)}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('report-content').innerHTML = reportHtml;
            
            const reportsCount = parseInt(localStorage.getItem('ssasReports') || '42') + 1;
            localStorage.setItem('ssasReports', reportsCount.toString());
            updateStats();
        }

        function generateStatistics() {
            showModal('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –º–æ–¥—É–ª—è –¢–ï–°–¢ –°–°–¢–û', `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</h3>
                        <div class="value">${requests.length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</h3>
                        <div class="value">${requests.filter(r => r.status === 'confirmed').length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–û–∂–∏–¥–∞–µ—Ç</h3>
                        <div class="value">${requests.filter(r => r.status === 'pending').length}</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">–ü–æ —Ç–∏–ø–∞–º —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤:</h3>
                <div class="stats-grid" style="margin-top: 10px;">
                    <div class="stat-card">
                        <h3>–ò–ù–ú–ê–†–°–ê–¢</h3>
                        <div class="value">${requests.filter(r => r.terminalType === 'INMARSAT').length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>–ò–†–ò–î–ò–£–ú</h3>
                        <div class="value">${requests.filter(r => r.terminalType === 'IRIDIUM').length}</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–∞—è–≤–æ–∫:</h3>
                <div class="stats-grid" style="margin-top: 10px;">
                    <div class="stat-card">
                        <h3>–í–µ–±-—Ñ–æ—Ä–º–∞</h3>
                        <div class="value">${requests.filter(r => !r.source || r.source === 'web').length}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Email</h3>
                        <div class="value">${requests.filter(r => r.source === 'email').length}</div>
                    </div>
                </div>
            `);
        }

        function viewSignalDetails() {
            showModal('–î–µ—Ç–∞–ª–∏ —Å–∏–≥–Ω–∞–ª–∞', `
                <div class="alert info">
                    <span>‚ÑπÔ∏è</span>
                    <div>
                        –¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω —Å –∑–∞—è–≤–∫–æ–π
                    </div>
                </div>
            `);
        }

        function showModal(title, content) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').innerHTML = content;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function exportReport() {
            showModal('–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF', `
                <div class="alert success">
                    <span>‚úÖ</span>
                    <div>
                        –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ PDF!<br>
                        –§–∞–π–ª: SSTO_Report_${new Date().toISOString().split('T')[0]}.pdf
                    </div>
                </div>
            `);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            
            const now = new Date();
            document.getElementById('last-check').textContent = 
                `—Å–µ–≥–æ–¥–Ω—è –≤ ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        });

        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>