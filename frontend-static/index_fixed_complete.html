<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–¥—É–ª—å –¢–µ—Å—Ç –°–°–¢–û</title>
    <link rel="stylesheet" href="https://unpkg.com/openlayers@7.3.0/dist/ol.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; position: relative; }
        .logo { font-size: 24px; }
        .logo span { font-weight: bold; }
        .actions { display: flex; gap: 10px; align-items: center; }
        
        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ API */
        #api-status { 
            font-size: 20px; 
            margin-right: 10px;
            cursor: help;
            transition: color 0.3s;
        }
        
        .btn { padding: 8px 16px; border: none; cursor: pointer; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-sm { padding: 4px 8px; font-size: 0.875em; }
        
        nav { margin: 20px 0; }
        .tab { padding: 10px 20px; margin-right: 5px; background: #f0f0f0; cursor: pointer; border-radius: 4px 4px 0 0; }
        .tab.active { background: white; border: 1px solid #ddd; border-bottom: none; }
        .content { display: none; padding: 20px; border: 1px solid #ddd; border-radius: 0 4px 4px 4px; }
        .content.active { display: block; }
        
        .stats { display: flex; gap: 20px; }
        .stat { flex: 1; padding: 20px; background: #f8f9fa; border-radius: 4px; }
        .stat h3 { margin: 0 0 10px; font-size: 14px; color: #666; }
        .stat p { font-size: 24px; margin: 0; font-weight: bold; }
        .stat small { display: block; color: #6c757d; margin-top: 5px; }
        
        .status { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 4px; }
        .quick-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        
        form { display: grid; gap: 15px; max-width: 600px; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        input, select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        small { color: #666; font-size: 0.9em; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #f0f0f0; font-weight: bold; }
        
        #map-container { height: 400px; border: 1px solid #ddd; }
        
        .status-badge { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8em; 
            font-weight: bold;
            display: inline-block;
        }
        .status-active, .status-confirmed { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-tested { background: #c7f3c7; color: #0d5f0d; }
        .status-pending { background: #fff3cd; color: #856404; }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        .notification.info { background: #17a2b8; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                üö¢ <span>–ú–û–î–£–õ–¨ –¢–ï–°–¢ –°–°–¢–û</span>
                <div style="font-size: 14px; color: #6c757d;">–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º –°–°–¢–û</div>
            </div>
            <div class="actions">
                <span id="api-status" title="–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è">‚óè</span>
                <button class="btn btn-primary" onclick="uploadExcel()">üìä –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel</button>
                <button class="btn btn-secondary" onclick="syncWithBackend()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</button>
            </div>
        </header>
        
        <nav>
            <button class="tab active" data-tab="dashboard">üìä –ì–ª–∞–≤–Ω–∞—è</button>
            <button class="tab" data-tab="new-request">‚ûï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
            <button class="tab" data-tab="requests">üìã –ó–∞—è–≤–∫–∏</button>
            <button class="tab" data-tab="signals">üì° –°–∏–≥–Ω–∞–ª—ã</button>
            <button class="tab" data-tab="terminals">üñ•Ô∏è –¢–µ—Ä–º–∏–Ω–∞–ª—ã</button>
            <button class="tab" data-tab="map">üó∫Ô∏è –ö–∞—Ä—Ç–∞</button>
            <button class="tab" data-tab="reports">üìà –û—Ç—á—ë—Ç—ã</button>
        </nav>
        
        <div id="dashboard" class="content active">
            <div class="stats">
                <div class="stat">
                    <h3>–ê–ö–¢–ò–í–ù–´–ï –ó–ê–Ø–í–ö–ò</h3>
                    <p id="active-requests">0</p>
                    <small>–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</small>
                </div>
                <div class="stat">
                    <h3>–û–ñ–ò–î–ê–Æ–¢ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø</h3>
                    <p id="pending-confirm">0</p>
                    <small>—Ç—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</small>
                </div>
                <div class="stat">
                    <h3>–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û</h3>
                    <p id="confirmed">0</p>
                    <small>–≥–æ—Ç–æ–≤—ã –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é</small>
                </div>
                <div class="stat">
                    <h3>–í–°–ï–ì–û –°–ò–ì–ù–ê–õ–û–í</h3>
                    <p id="total-signals">0</p>
                    <small>–∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</small>
                </div>
            </div>
            
            <div class="status">
                <h3>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h3>
                <p>–†–µ–∂–∏–º –∞–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: <strong id="auto-confirm-status">–û–¢–ö–õ–Æ–ß–ï–ù</strong></p>
                <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É: <strong id="connection-status">–ü—Ä–æ–≤–µ—Ä–∫–∞...</strong></p>
                <button class="btn btn-primary" onclick="toggleAutoConfirm()">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º</button>
            </div>
            
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="generateTestData()">üé≤ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
                <button class="btn btn-secondary" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
                <button class="btn btn-secondary" onclick="exportData()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
                <button class="btn btn-secondary" onclick="importData()">üì• –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
            </div>
        </div>
        
        <div id="new-request" class="content">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –°–°–¢–û</h2>
            <form id="new-request-form">
                <div>
                    <label for="terminal-number">–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏ –°–°–¢–û *</label>
                    <input type="text" id="terminal-number" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: TERM001">
                    <small>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–µ—Ä–º–∏–Ω–∞–ª–∞</small>
                </div>
                <div>
                    <label for="vessel-name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—É–¥–Ω–∞ *</label>
                    <input type="text" id="vessel-name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–ø–∏—Ç–∞–Ω –ò–≤–∞–Ω–æ–≤">
                </div>
                <div>
                    <label for="mmsi">MMSI *</label>
                    <input type="text" id="mmsi" required pattern="[0-9]{9}" placeholder="9 —Ü–∏—Ñ—Ä">
                </div>
                <div>
                    <label for="imo">IMO</label>
                    <input type="text" id="imo" pattern="[0-9]{7}" placeholder="7 —Ü–∏—Ñ—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
                </div>
                <div>
                    <label for="sat-type">–¢–∏–ø —Å–ø—É—Ç–Ω–∏–∫–æ–≤–æ–π —Å–≤—è–∑–∏ *</label>
                    <select id="sat-type" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                        <option value="INMARSAT">–ò–ù–ú–ê–†–°–ê–¢</option>
                        <option value="IRIDIUM">–ò–†–ò–î–ò–£–ú</option>
                    </select>
                </div>
                <div>
                    <label for="owner">–°—É–¥–æ–≤–ª–∞–¥–µ–ª–µ—Ü *</label>
                    <input type="text" id="owner" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                </div>
                <div>
                    <label for="email">Email *</label>
                    <input type="email" id="email" required placeholder="contact@example.com">
                </div>
                <div>
                    <label for="test-date">–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞ *</label>
                    <input type="date" id="test-date" required>
                </div>
                <div>
                    <label for="test-time">–í—Ä–µ–º—è —Ç–µ—Å—Ç–∞</label>
                    <input type="time" id="test-time">
                </div>
                <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
            </form>
        </div>
        
        <div id="requests" class="content">
            <h2>–°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="loadRequests()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-secondary" onclick="exportRequests()">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>IMO</th>
                        <th>–î–∞—Ç–∞ —Ç–µ—Å—Ç–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="requests-tbody">
                    <tr><td colspan="8" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                </tbody>
            </table>
        </div>
        
        <div id="signals" class="content">
            <h2>–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã –°–°–¢–û</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="loadSignals()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn btn-primary" onclick="simulateSignal()">üì° –°–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–∏–≥–Ω–∞–ª</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–ù–æ–º–µ—Ä</th>
                        <th>–¢–µ—Ä–º–∏–Ω–∞–ª</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>–¢–∏–ø</th>
                        <th>–í—Ä–µ–º—è</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="signals-tbody">
                    <tr><td colspan="9" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                </tbody>
            </table>
        </div>
        
        <div id="terminals" class="content">
            <h2>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤ –°–°–¢–û</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="addTerminal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª</button>
                <button class="btn btn-secondary" onclick="loadTerminals()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>–ù–æ–º–µ—Ä —Å—Ç–æ–π–∫–∏</th>
                        <th>–°—É–¥–Ω–æ</th>
                        <th>MMSI</th>
                        <th>–¢–∏–ø —Å–≤—è–∑–∏</th>
                        <th>–í–ª–∞–¥–µ–ª–µ—Ü</th>
                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="terminals-tbody">
                    <tr><td colspan="8" style="text-align: center; color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                </tbody>
            </table>
        </div>
        
        <div id="map" class="content">
            <h2>–ö–∞—Ä—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –°–°–¢–û</h2>
            <div id="map-container"></div>
            <div style="margin-top: 10px;">
                <button class="btn btn-primary" onclick="showAllSignals()">üéØ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
                <button class="btn btn-secondary" onclick="clearMap()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        
        <div id="reports" class="content">
            <h2>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–æ–≤</h2>
            <form id="report-form">
                <div>
                    <label for="report-type">–¢–∏–ø –æ—Ç—á—ë—Ç–∞</label>
                    <select id="report-type">
                        <option value="daily">–°—É—Ç–æ—á–Ω—ã–π</option>
                        <option value="weekly">–ù–µ–¥–µ–ª—å–Ω—ã–π</option>
                        <option value="monthly">–ú–µ—Å—è—á–Ω—ã–π</option>
                        <option value="custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</option>
                    </select>
                </div>
                <div id="report-period" style="display: none;">
                    <label>–ü–µ—Ä–∏–æ–¥</label>
                    <input type="date" id="report-start" placeholder="–ù–∞—á–∞–ª–æ">
                    <input type="date" id="report-end" placeholder="–ö–æ–Ω–µ—Ü">
                </div>
                <button type="submit" class="btn btn-primary">üìä –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç</button>
            </form>
        </div>
    </div>
    
    <script src="https://unpkg.com/openlayers@7.3.0/dist/ol.js"></script>
    <script src="https://unpkg.com/xlsx@latest/dist/xlsx.full.min.js"></script>
    <script>
        // ===================== –£–ª—É—á—à–µ–Ω–Ω—ã–π Backend API –∫–ª–∞—Å—Å =====================
        class BackendAPI {
            constructor() {
                this.baseURL = 'http://localhost:3001';
                this.headers = {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer test-token'
                };
                this.isOnline = false;
                this.retryCount = 0;
                this.maxRetries = 3;
            }
            
            async request(method, endpoint, data = null, retry = 0) {
                try {
                    const url = this.baseURL + endpoint;
                    console.log(`[API] ${method} ${endpoint}`);
                    
                    const options = {
                        method,
                        headers: this.headers
                    };
                    
                    if (data && method !== 'GET') {
                        options.body = JSON.stringify(data);
                    }
                    
                    const response = await fetch(url, options);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    this.setOnlineStatus(true);
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å –º–∞—Å—Å–∏–≤ –∏–ª–∏ –æ–±—ä–µ–∫—Ç —Å data
                    if (result && result.data !== undefined) {
                        return result.data;
                    }
                    return result || [];
                    
                } catch (error) {
                    console.warn(`[API] Error: ${error.message}`);
                    
                    // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                    if (retry < this.maxRetries) {
                        console.log(`[API] Retry ${retry + 1}/${this.maxRetries}...`);
                        await new Promise(resolve => setTimeout(resolve, 1000 * (retry + 1)));
                        return this.request(method, endpoint, data, retry + 1);
                    }
                    
                    this.setOnlineStatus(false);
                    return this.fallbackToLocalStorage(method, endpoint, data);
                }
            }
            
            setOnlineStatus(isOnline) {
                this.isOnline = isOnline;
                const indicator = document.getElementById('api-status');
                const status = document.getElementById('connection-status');
                
                if (indicator) {
                    if (isOnline) {
                        indicator.style.color = '#28a745';
                        indicator.title = '–°–µ—Ä–≤–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω';
                    } else {
                        indicator.style.color = '#ffc107';
                        indicator.title = '–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º (LocalStorage)';
                    }
                }
                
                if (status) {
                    status.textContent = isOnline ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É' : '–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
                    status.style.color = isOnline ? '#28a745' : '#ffc107';
                }
            }
            
            fallbackToLocalStorage(method, endpoint, data) {
                console.log('[Storage] Using LocalStorage fallback');
                
                const parts = endpoint.split('/').filter(p => p);
                const entity = parts[0];
                const id = parts[1];
                
                const storageKey = `ssto_${entity}`;
                let store = [];
                
                try {
                    store = JSON.parse(localStorage.getItem(storageKey) || '[]');
                } catch (e) {
                    console.error('[Storage] Parse error:', e);
                    store = [];
                }
                
                if (method === 'GET') {
                    if (id) {
                        return store.find(item => item.id == id) || null;
                    }
                    return store;
                    
                } else if (method === 'POST') {
                    const newItem = {
                        ...data,
                        id: this.generateId(entity),
                        created_at: new Date().toISOString()
                    };
                    store.push(newItem);
                    localStorage.setItem(storageKey, JSON.stringify(store));
                    showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ', 'info');
                    return newItem;
                    
                } else if (method === 'PUT' || method === 'PATCH') {
                    const index = store.findIndex(item => item.id == id);
                    if (index !== -1) {
                        store[index] = { ...store[index], ...data, updated_at: new Date().toISOString() };
                        localStorage.setItem(storageKey, JSON.stringify(store));
                        return store[index];
                    }
                    return null;
                    
                } else if (method === 'DELETE') {
                    store = store.filter(item => item.id != id);
                    localStorage.setItem(storageKey, JSON.stringify(store));
                    return { success: true };
                }
                
                return null;
            }
            
            generateId(entity) {
                const prefix = entity.toUpperCase().substring(0, 3);
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 1000);
                return `${prefix}-${timestamp}-${random}`;
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä API
        const api = new BackendAPI();

        // ===================== –£—Ç–∏–ª–∏—Ç—ã =====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('ru-RU');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleString('ru-RU');
        }

        // ===================== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ =====================
        document.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab[data-tab]');
            if (!tab) return;
            
            e.preventDefault();
            const targetId = tab.dataset.tab;
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            const target = document.getElementById(targetId);
            if (target) {
                target.classList.add('active');
                tab.classList.add('active');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∫–∞–∑–µ
                if (targetId === 'map' && !window.mapInitialized) {
                    setTimeout(initMap, 100);
                    window.mapInitialized = true;
                }
            }
        });

        // ===================== –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π =====================
        async function loadDashboard() {
            try {
                const requests = await api.request('GET', '/requests') || [];
                const signals = await api.request('GET', '/signals') || [];
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤
                const requestsArray = Array.isArray(requests) ? requests : [];
                const signalsArray = Array.isArray(signals) ? signals : [];
                
                document.getElementById('active-requests').textContent = requestsArray.length;
                document.getElementById('pending-confirm').textContent = 
                    requestsArray.filter(r => r && r.status === 'pending').length;
                document.getElementById('confirmed').textContent = 
                    requestsArray.filter(r => r && r.status === 'confirmed').length;
                document.getElementById('total-signals').textContent = signalsArray.length;
                
                const autoConfirm = localStorage.getItem('autoConfirm') === 'true';
                document.getElementById('auto-confirm-status').textContent = 
                    autoConfirm ? '–í–ö–õ–Æ–ß–ï–ù' : '–û–¢–ö–õ–Æ–ß–ï–ù';
                    
            } catch (error) {
                console.error('[Dashboard] Load error:', error);
            }
        }

        async function loadRequests() {
            try {
                const tbody = document.getElementById('requests-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
                
                const data = await api.request('GET', '/requests');
                const requests = Array.isArray(data) ? data : [];
                
                tbody.innerHTML = '';
                
                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>';
                    return;
                }
                
                requests.forEach(req => {
                    if (!req) return;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${req.id || ''}</td>
                        <td>${req.terminal_number || ''}</td>
                        <td>${req.vessel_name || ''}</td>
                        <td>${req.mmsi || ''}</td>
                        <td>${req.imo_number || req.imo || ''}</td>
                        <td>${formatDate(req.planned_test_date || req.test_date)}</td>
                        <td><span class="status-badge status-${req.status || 'pending'}">${(req.status || 'pending').toUpperCase()}</span></td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="confirmRequest('${req.id}')">‚úì</button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteRequest('${req.id}')">‚úó</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('[Requests] Load error:', error);
                const tbody = document.getElementById('requests-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
                }
            }
        }

        async function loadSignals() {
            try {
                const tbody = document.getElementById('signals-tbody');
                if (!tbody) return;
                
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
                
                const data = await api.request('GET', '/signals');
                const signals = Array.isArray(data) ? data : [];
                
                tbody.innerHTML = '';
                
                if (signals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">–ù–µ—Ç —Å–∏–≥–Ω–∞–ª–æ–≤</td></tr>';
                    return;
                }
                
                signals.forEach(sig => {
                    if (!sig) return;
                    
                    const row = document.createElement('tr');
                    const isTest = sig.is_test || sig.signal_type === 'TEST';
                    
                    row.innerHTML = `
                        <td>${sig.id || ''}</td>
                        <td>${sig.signal_number || sig.id || ''}</td>
                        <td>${sig.terminal_number || ''}</td>
                        <td>${sig.vessel_name || ''}</td>
                        <td>${sig.mmsi || ''}</td>
                        <td>${sig.signal_type || sig.type || ''}</td>
                        <td>${formatDateTime(sig.received_at || sig.created_at)}</td>
                        <td><span class="status-badge status-${isTest ? 'tested' : 'active'}">${isTest ? '–¢–ï–°–¢' : '–¢–†–ï–í–û–ì–ê'}</span></td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="processSignal('${sig.id}')">–û–±—Ä–∞–±–æ—Ç–∞—Ç—å</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('[Signals] Load error:', error);
                const tbody = document.getElementById('signals-tbody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
                }
            }
        }

        async function loadTerminals() {
            try {
                const tbody = document.getElementById('terminals-tbody');
                if (!tbody) return;
                
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ –∏–∑ localStorage
                let terminals = [];
                try {
                    terminals = await api.request('GET', '/terminals');
                } catch (e) {
                    terminals = JSON.parse(localStorage.getItem('ssto_terminals') || '[]');
                }
                
                terminals = Array.isArray(terminals) ? terminals : [];
                
                tbody.innerHTML = '';
                
                if (terminals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #999;">–ù–µ—Ç —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤</td></tr>';
                    return;
                }
                
                terminals.forEach(terminal => {
                    if (!terminal) return;
                    
                    const statusText = {
                        'active': '–ê–∫—Ç–∏–≤–µ–Ω',
                        'inactive': '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω',
                        'tested': '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω'
                    }[terminal.status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${terminal.terminal_number || terminal.id || ''}</td>
                        <td>${terminal.vessel_name || ''}</td>
                        <td>${terminal.mmsi || ''}</td>
                        <td>${terminal.type || '–ò–ù–ú–ê–†–°–ê–¢'}</td>
                        <td>${terminal.owner || ''}</td>
                        <td>${formatDate(terminal.last_test)}</td>
                        <td><span class="status-badge status-${terminal.status || 'inactive'}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="testTerminal('${terminal.terminal_number || terminal.id}')">–¢–µ—Å—Ç</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('[Terminals] Load error:', error);
            }
        }

        // ===================== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º =====================
        document.getElementById('new-request-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const requestData = {
                terminal_number: document.getElementById('terminal-number').value,
                vessel_name: document.getElementById('vessel-name').value,
                mmsi: document.getElementById('mmsi').value,
                imo_number: document.getElementById('imo').value,
                satellite_type: document.getElementById('sat-type').value,
                owner_name: document.getElementById('owner').value,
                owner_email: document.getElementById('email').value,
                planned_test_date: document.getElementById('test-date').value,
                planned_test_time: document.getElementById('test-time').value,
                status: 'pending'
            };
            
            try {
                await api.request('POST', '/requests', requestData);
                showNotification('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                e.target.reset();
                await loadRequests();
                await loadDashboard();
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –∑–∞—è–≤–æ–∫
                document.querySelector('.tab[data-tab="requests"]').click();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏', 'error');
                console.error(error);
            }
        });

        document.getElementById('report-type').addEventListener('change', (e) => {
            const periodDiv = document.getElementById('report-period');
            periodDiv.style.display = e.target.value === 'custom' ? 'block' : 'none';
        });

        // ===================== –§—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π =====================
        async function confirmRequest(id) {
            try {
                await api.request('PATCH', `/requests/${id}`, { status: 'confirmed' });
                showNotification('–ó–∞—è–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞', 'success');
                await loadRequests();
                await loadDashboard();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏', 'error');
            }
        }

        async function deleteRequest(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É?')) return;
            
            try {
                await api.request('DELETE', `/requests/${id}`);
                showNotification('–ó–∞—è–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞', 'info');
                await loadRequests();
                await loadDashboard();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
            }
        }

        async function testTerminal(terminalNumber) {
            const signal = {
                terminal_number: terminalNumber,
                signal_type: 'TEST',
                received_at: new Date().toISOString(),
                is_test: true,
                vessel_name: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å—É–¥–Ω–æ',
                mmsi: '000000000'
            };
            
            try {
                await api.request('POST', '/signals', signal);
                showNotification('–¢–µ—Å—Ç–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
                await loadSignals();
                await loadDashboard();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏–≥–Ω–∞–ª–∞', 'error');
            }
        }

        async function processSignal(id) {
            showNotification('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–∞...', 'info');
            // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–∞
        }

        function generateTestData() {
            const testData = {
                requests: [
                    {
                        id: api.generateId('requests'),
                        terminal_number: 'TERM' + Math.floor(Math.random() * 1000),
                        vessel_name: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å—É–¥–Ω–æ ' + Math.floor(Math.random() * 100),
                        mmsi: String(Math.floor(Math.random() * 900000000) + 100000000),
                        imo_number: String(Math.floor(Math.random() * 9000000) + 1000000),
                        owner_name: '–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è',
                        owner_email: 'test@example.com',
                        planned_test_date: new Date().toISOString().split('T')[0],
                        status: 'pending'
                    }
                ],
                signals: [
                    {
                        id: api.generateId('signals'),
                        signal_number: 'SIG' + Math.floor(Math.random() * 10000),
                        terminal_number: 'TERM001',
                        vessel_name: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å—É–¥–Ω–æ',
                        mmsi: '123456789',
                        signal_type: 'TEST',
                        received_at: new Date().toISOString(),
                        is_test: true
                    }
                ],
                terminals: [
                    {
                        id: api.generateId('terminals'),
                        terminal_number: 'TERM' + Math.floor(Math.random() * 1000),
                        vessel_name: '–°—É–¥–Ω–æ ' + Math.floor(Math.random() * 100),
                        mmsi: String(Math.floor(Math.random() * 900000000) + 100000000),
                        type: Math.random() > 0.5 ? '–ò–ù–ú–ê–†–°–ê–¢' : '–ò–†–ò–î–ò–£–ú',
                        owner: '–í–ª–∞–¥–µ–ª–µ—Ü ' + Math.floor(Math.random() * 50),
                        last_test: new Date(Date.now() - Math.random() * 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: 'active'
                    }
                ]
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('ssto_requests', JSON.stringify(testData.requests));
            localStorage.setItem('ssto_signals', JSON.stringify(testData.signals));
            localStorage.setItem('ssto_terminals', JSON.stringify(testData.terminals));
            
            showNotification('–¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
            loadDashboard();
            loadRequests();
            loadSignals();
            loadTerminals();
        }

        function clearAllData() {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;
            
            localStorage.removeItem('ssto_requests');
            localStorage.removeItem('ssto_signals');
            localStorage.removeItem('ssto_terminals');
            
            showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã', 'info');
            loadDashboard();
            loadRequests();
            loadSignals();
            loadTerminals();
        }

        async function syncWithBackend() {
            showNotification('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...', 'info');
            await checkBackendStatus();
            await loadDashboard();
            await loadRequests();
            await loadSignals();
            await loadTerminals();
            showNotification('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
        }

        // ===================== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ backend =====================
        async function checkBackendStatus() {
            try {
                const response = await fetch('http://localhost:3001/health', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    api.setOnlineStatus(true);
                    console.log('[Health] Backend online:', data);
                } else {
                    throw new Error('Backend offline');
                }
            } catch (error) {
                api.setOnlineStatus(false);
                console.log('[Health] Backend offline, using LocalStorage');
            }
        }

        // ===================== –ó–∞–≥–ª—É—à–∫–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ =====================
        function toggleAutoConfirm() {
            const current = localStorage.getItem('autoConfirm') === 'true';
            localStorage.setItem('autoConfirm', !current);
            loadDashboard();
            showNotification(`–ê–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ${!current ? '–≤–∫–ª—é—á–µ–Ω–æ' : '–æ—Ç–∫–ª—é—á–µ–Ω–æ'}`, 'info');
        }

        function uploadExcel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx,.xls';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    showNotification(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ${file.name}...`, 'info');
                    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Excel
                }
            };
            input.click();
        }

        function exportData() {
            const data = {
                requests: JSON.parse(localStorage.getItem('ssto_requests') || '[]'),
                signals: JSON.parse(localStorage.getItem('ssto_signals') || '[]'),
                terminals: JSON.parse(localStorage.getItem('ssto_terminals') || '[]')
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ssto_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.requests) localStorage.setItem('ssto_requests', JSON.stringify(data.requests));
                            if (data.signals) localStorage.setItem('ssto_signals', JSON.stringify(data.signals));
                            if (data.terminals) localStorage.setItem('ssto_terminals', JSON.stringify(data.terminals));
                            
                            showNotification('–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
                            loadDashboard();
                            loadRequests();
                            loadSignals();
                            loadTerminals();
                        } catch (error) {
                            showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function addTerminal() {
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞
            showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        function exportRequests() {
            // –≠–∫—Å–ø–æ—Ä—Ç –∑–∞—è–≤–æ–∫ –≤ CSV
            showNotification('–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        function simulateSignal() {
            testTerminal('TERM-SIMULATION');
        }

        function showAllSignals() {
            showNotification('–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ', 'info');
        }

        function clearMap() {
            if (window.olMap) {
                // –û—á–∏—Å—Ç–∫–∞ —Å–ª–æ–µ–≤ –∫–∞—Ä—Ç—ã
                showNotification('–ö–∞—Ä—Ç–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
            }
        }

        // ===================== –ö–∞—Ä—Ç–∞ OpenLayers =====================
        let olMap;
        function initMap() {
            if (!olMap && document.getElementById('map-container')) {
                olMap = new ol.Map({
                    target: 'map-container',
                    layers: [
                        new ol.layer.Tile({
                            source: new ol.source.OSM()
                        })
                    ],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([37.6173, 55.7558]),
                        zoom: 4
                    })
                });
                console.log('[Map] Initialized');
            }
        }

        // ===================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ =====================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('[App] Starting SSTO Test Module...');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å backend
            await checkBackendStatus();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            await loadDashboard();
            await loadRequests();
            await loadSignals();
            await loadTerminals();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            setInterval(checkBackendStatus, 30000);
            
            console.log('[App] Ready');
        });
    </script>
</body>
</html>